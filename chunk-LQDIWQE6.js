import{A as jr,B as re,C as Wr,D as Hr,E as Me,F as Gt,G as Yr,H as Jr,I as Xr,K as Zr,L as Le,M as se,N as Oe,O as qe,Q as ts,R as es,S as ns,T as rs,U as Be,o as Rr,p as Pr,q as Vr,r as Dr,s as xr,t as Cr,u as Nr,v as kr,z as $r}from"./chunk-7ZYULKDX.js";import{l as Ut,m as Br,n as Ur,o as Gr,p as zr,q as Kr,r as Qr,s as Fe}from"./chunk-77HBHVUW.js";import{a as Fr,d as Mr}from"./chunk-OKNBJC5B.js";import{b as W,c as Sr}from"./chunk-OAMQ53XU.js";import{Ad as Or,Bd as qr,Gb as qt,Hb as Bt,Kb as br,La as it,Ma as xe,O as Tr,Pb as Ne,Qb as ke,W as De,ea as vr,eb as Ce,nb as Lt,o as J,oa as _t,ob as Ot,u as j,v as Er,va as Mt,wa as Ar,zd as Lr}from"./chunk-N5O566FX.js";import{a as pt,f as p}from"./chunk-CQCHLVVT.js";var ss=(()=>{let t=class t{constructor(n,s){this.data=n,this.dialogRef=s}};t.\u0275fac=function(s){return new(s||t)(xe(Pr),xe(Rr))},t.\u0275cmp=vr({type:t,selectors:[["app-confirm-dialog"]],standalone:!0,features:[br],decls:11,vars:10,consts:[["mat-dialog-title",""],["mat-dialog-content",""],["mat-dialog-actions","","align","center"],["mat-button","",3,"mat-dialog-close"],["mat-button","","cdkFocusInitial","",3,"mat-dialog-close"]],template:function(s,i){s&1&&(Lt(0,"h1",0),qt(1),Ot(),Lt(2,"div",1),qt(3),Ot(),Lt(4,"div",2)(5,"button",3),qt(6),Ne(7,"translate"),Ot(),Lt(8,"button",4),qt(9),Ne(10,"translate"),Ot()()),s&2&&(it(),Bt(i.data.title),it(2),Bt(i.data.content),it(2),Ce("mat-dialog-close",!1),it(),Bt(ke(7,6,"uni.no")),it(2),Ce("mat-dialog-close",!0),it(),Bt(ke(10,8,"uni.yes")))},dependencies:[kr,Dr,xr,Nr,Cr,Mr,Fr,qr,Or],changeDetection:0});let r=t;return r})();var is=(()=>{let t=class t{constructor(n){this.dialog=n}open(n,s){return this.dialog.open(ss,{width:"sm",data:{title:n,content:s}}).afterClosed()}};t.\u0275fac=function(s){return new(s||t)(Mt(Vr))},t.\u0275prov=_t({token:t,factory:t.\u0275fac,providedIn:"root"});let r=t;return r})();var zt=function(r){return r[r.Delete=0]="Delete",r[r.UnsavedWork=1]="UnsavedWork",r}(zt||{}),ko=(()=>{let t=class t{constructor(n,s){this.confirm=n,this.translate=s}openCustomConfirmDialog(n){let s=this.getTitle(n),i=this.getContent(n);return this.open(s,i)}getTitle(n){switch(n){case zt.Delete:return this.translate.instant("custom-confirm-dialog.delete-post.title");case zt.UnsavedWork:return this.translate.instant("custom-confirm-dialog.unsaved-work.title");default:return this.translate.instant("custom-confirm-dialog.default.title")}}getContent(n){switch(n){case zt.Delete:return this.translate.instant("custom-confirm-dialog.delete-post.content");case zt.UnsavedWork:return this.translate.instant("custom-confirm-dialog.unsaved-work.content");default:return this.translate.instant("custom-confirm-dialog.default.content")}}open(n,s){return this.confirm.open(n,s).pipe(Tr(),j(i=>!!i))}};t.\u0275fac=function(s){return new(s||t)(Mt(is),Mt(Lr))},t.\u0275prov=_t({token:t,factory:t.\u0275fac,providedIn:"root"});let r=t;return r})();var os="@firebase/firestore";var k=class{constructor(t){this.uid=t}isAuthenticated(){return this.uid!=null}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}};k.UNAUTHENTICATED=new k(null),k.GOOGLE_CREDENTIALS=new k("google-credentials-uid"),k.FIRST_PARTY=new k("first-party-uid"),k.MOCK_USER=new k("mock-user");var Ft="10.8.1";var ht=new Sr("@firebase/firestore");function Kt(){return ht.logLevel}function m(r,...t){if(ht.logLevel<=W.DEBUG){let e=t.map(lr);ht.debug(`Firestore (${Ft}): ${r}`,...e)}}function Z(r,...t){if(ht.logLevel<=W.ERROR){let e=t.map(lr);ht.error(`Firestore (${Ft}): ${r}`,...e)}}function Qe(r,...t){if(ht.logLevel<=W.WARN){let e=t.map(lr);ht.warn(`Firestore (${Ft}): ${r}`,...e)}}function lr(r){if(typeof r=="string")return r;try{return function(e){return JSON.stringify(e)}(r)}catch{return r}}function w(r="Unexpected state"){let t=`FIRESTORE (${Ft}) INTERNAL ASSERTION FAILED: `+r;throw Z(t),new Error(t)}function C(r,t){r||w()}function v(r,t){return r}var f={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},y=class extends Gr{constructor(t,e){super(t,e),this.code=t,this.message=e,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}};var K=class{constructor(){this.promise=new Promise((t,e)=>{this.resolve=t,this.reject=e})}};var $e=class{constructor(t,e){this.user=e,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${t}`)}},je=class{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable(()=>e(k.UNAUTHENTICATED))}shutdown(){}};var We=class{constructor(t){this.t=t,this.currentUser=k.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,e){let n=this.i,s=c=>this.i!==n?(n=this.i,e(c)):Promise.resolve(),i=new K;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new K,t.enqueueRetryable(()=>s(this.currentUser))};let o=()=>{let c=i;t.enqueueRetryable(()=>p(this,null,function*(){yield c.promise,yield s(this.currentUser)}))},a=c=>{m("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=c,this.auth.addAuthTokenListener(this.o),o()};this.t.onInit(c=>a(c)),setTimeout(()=>{if(!this.auth){let c=this.t.getImmediate({optional:!0});c?a(c):(m("FirebaseAuthCredentialsProvider","Auth not yet detected"),i.resolve(),i=new K)}},0),o()}getToken(){let t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then(n=>this.i!==t?(m("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):n?(C(typeof n.accessToken=="string"),new $e(n.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){let t=this.auth&&this.auth.getUid();return C(t===null||typeof t=="string"),new k(t)}},He=class{constructor(t,e,n){this.l=t,this.h=e,this.P=n,this.type="FirstParty",this.user=k.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);let t=this.T();return t&&this.I.set("Authorization",t),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}},Ye=class{constructor(t,e,n){this.l=t,this.h=e,this.P=n}getToken(){return Promise.resolve(new He(this.l,this.h,this.P))}start(t,e){t.enqueueRetryable(()=>e(k.FIRST_PARTY))}shutdown(){}invalidateToken(){}},Je=class{constructor(t){this.value=t,this.type="AppCheck",this.headers=new Map,t&&t.length>0&&this.headers.set("x-firebase-appcheck",this.value)}},Xe=class{constructor(t){this.A=t,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(t,e){let n=i=>{i.error!=null&&m("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${i.error.message}`);let o=i.token!==this.R;return this.R=i.token,m("FirebaseAppCheckTokenProvider",`Received ${o?"new":"existing"} token.`),o?e(i.token):Promise.resolve()};this.o=i=>{t.enqueueRetryable(()=>n(i))};let s=i=>{m("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=i,this.appCheck.addTokenListener(this.o)};this.A.onInit(i=>s(i)),setTimeout(()=>{if(!this.appCheck){let i=this.A.getImmediate({optional:!0});i?s(i):m("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){let t=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(t).then(e=>e?(C(typeof e.token=="string"),this.R=e.token,new Je(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}};function oi(r){let t=typeof self<"u"&&(self.crypto||self.msCrypto),e=new Uint8Array(r);if(t&&typeof t.getRandomValues=="function")t.getRandomValues(e);else for(let n=0;n<r;n++)e[n]=Math.floor(256*Math.random());return e}var Ze=class{static newId(){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=Math.floor(256/t.length)*t.length,n="";for(;n.length<20;){let s=oi(40);for(let i=0;i<s.length;++i)n.length<20&&s[i]<e&&(n+=t.charAt(s[i]%t.length))}return n}};function A(r,t){return r<t?-1:r>t?1:0}function Et(r,t,e){return r.length===t.length&&r.every((n,s)=>e(n,t[s]))}var U=class r{constructor(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new y(f.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new y(f.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new y(f.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new y(f.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}static now(){return r.fromMillis(Date.now())}static fromDate(t){return r.fromMillis(t.getTime())}static fromMillis(t){let e=Math.floor(t/1e3),n=Math.floor(1e6*(t-1e3*e));return new r(e,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(t){return this.seconds===t.seconds?A(this.nanoseconds,t.nanoseconds):A(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){let t=this.seconds- -62135596800;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}};var S=class r{constructor(t){this.timestamp=t}static fromTimestamp(t){return new r(t)}static min(){return new r(new U(0,0))}static max(){return new r(new U(253402300799,999999999))}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}};var le=class r{constructor(t,e,n){e===void 0?e=0:e>t.length&&w(),n===void 0?n=t.length-e:n>t.length-e&&w(),this.segments=t,this.offset=e,this.len=n}get length(){return this.len}isEqual(t){return r.comparator(this,t)===0}child(t){let e=this.segments.slice(this.offset,this.limit());return t instanceof r?t.forEach(n=>{e.push(n)}):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return t=t===void 0?1:t,this.construct(this.segments,this.offset+t,this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return this.length===0}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,e){let n=Math.min(t.length,e.length);for(let s=0;s<n;s++){let i=t.get(s),o=e.get(s);if(i<o)return-1;if(i>o)return 1}return t.length<e.length?-1:t.length>e.length?1:0}},F=class r extends le{construct(t,e,n){return new r(t,e,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...t){let e=[];for(let n of t){if(n.indexOf("//")>=0)throw new y(f.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);e.push(...n.split("/").filter(s=>s.length>0))}return new r(e)}static emptyPath(){return new r([])}},ai=/^[_a-zA-Z][_a-zA-Z0-9]*$/,G=class r extends le{construct(t,e,n){return new r(t,e,n)}static isValidIdentifier(t){return ai.test(t)}canonicalString(){return this.toArray().map(t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),r.isValidIdentifier(t)||(t="`"+t+"`"),t)).join(".")}toString(){return this.canonicalString()}isKeyField(){return this.length===1&&this.get(0)==="__name__"}static keyField(){return new r(["__name__"])}static fromServerFormat(t){let e=[],n="",s=0,i=()=>{if(n.length===0)throw new y(f.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(n),n=""},o=!1;for(;s<t.length;){let a=t[s];if(a==="\\"){if(s+1===t.length)throw new y(f.INVALID_ARGUMENT,"Path has trailing escape character: "+t);let c=t[s+1];if(c!=="\\"&&c!=="."&&c!=="`")throw new y(f.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);n+=c,s+=2}else a==="`"?(o=!o,s++):a!=="."||o?(n+=a,s++):(i(),s++)}if(i(),o)throw new y(f.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new r(e)}static emptyPath(){return new r([])}};var E=class r{constructor(t){this.path=t}static fromPath(t){return new r(F.fromString(t))}static fromName(t){return new r(F.fromString(t).popFirst(5))}static empty(){return new r(F.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(t){return t!==null&&F.comparator(this.path,t.path)===0}toString(){return this.path.toString()}static comparator(t,e){return F.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new r(new F(t.slice()))}};var tn=class{constructor(t,e,n,s){this.indexId=t,this.collectionGroup=e,this.fields=n,this.indexState=s}};tn.UNKNOWN_ID=-1;function ci(r,t){let e=r.toTimestamp().seconds,n=r.toTimestamp().nanoseconds+1,s=S.fromTimestamp(n===1e9?new U(e+1,0):new U(e,n));return new dt(s,E.empty(),t)}function ui(r){return new dt(r.readTime,r.key,-1)}var dt=class r{constructor(t,e,n){this.readTime=t,this.documentKey=e,this.largestBatchId=n}static min(){return new r(S.min(),E.empty(),-1)}static max(){return new r(S.max(),E.empty(),-1)}};function li(r,t){let e=r.readTime.compareTo(t.readTime);return e!==0?e:(e=E.comparator(r.documentKey,t.documentKey),e!==0?e:A(r.largestBatchId,t.largestBatchId))}var hi="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.",en=class{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(t=>t())}};function vs(r){return p(this,null,function*(){if(r.code!==f.FAILED_PRECONDITION||r.message!==hi)throw r;m("LocalStore","Unexpectedly lost primary lease")})}var h=class r{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(t){return this.next(void 0,t)}next(t,e){return this.callbackAttached&&w(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(e,this.error):this.wrapSuccess(t,this.result):new r((n,s)=>{this.nextCallback=i=>{this.wrapSuccess(t,i).next(n,s)},this.catchCallback=i=>{this.wrapFailure(e,i).next(n,s)}})}toPromise(){return new Promise((t,e)=>{this.next(t,e)})}wrapUserFunction(t){try{let e=t();return e instanceof r?e:r.resolve(e)}catch(e){return r.reject(e)}}wrapSuccess(t,e){return t?this.wrapUserFunction(()=>t(e)):r.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction(()=>t(e)):r.reject(e)}static resolve(t){return new r((e,n)=>{e(t)})}static reject(t){return new r((e,n)=>{n(t)})}static waitFor(t){return new r((e,n)=>{let s=0,i=0,o=!1;t.forEach(a=>{++s,a.next(()=>{++i,o&&i===s&&e()},c=>n(c))}),o=!0,i===s&&e()})}static or(t){let e=r.resolve(!1);for(let n of t)e=e.next(s=>s?r.resolve(s):n());return e}static forEach(t,e){let n=[];return t.forEach((s,i)=>{n.push(e.call(this,s,i))}),this.waitFor(n)}static mapArray(t,e){return new r((n,s)=>{let i=t.length,o=new Array(i),a=0;for(let c=0;c<i;c++){let u=c;e(t[u]).next(l=>{o[u]=l,++a,a===i&&n(o)},l=>s(l))}})}static doWhile(t,e){return new r((n,s)=>{let i=()=>{t()===!0?e().next(()=>{i()},s):n()};i()})}};var nn=class r{constructor(t,e){this.action=t,this.transaction=e,this.aborted=!1,this.V=new K,this.transaction.oncomplete=()=>{this.V.resolve()},this.transaction.onabort=()=>{e.error?this.V.reject(new ct(t,e.error)):this.V.resolve()},this.transaction.onerror=n=>{let s=hr(n.target.error);this.V.reject(new ct(t,s))}}static open(t,e,n,s){try{return new r(e,t.transaction(s,n))}catch(i){throw new ct(e,i)}}get m(){return this.V.promise}abort(t){t&&this.V.reject(t),this.aborted||(m("SimpleDb","Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}g(){let t=this.transaction;this.aborted||typeof t.commit!="function"||t.commit()}store(t){let e=this.transaction.objectStore(t);return new sn(e)}},he=class r{constructor(t,e,n){this.name=t,this.version=e,this.p=n,r.S(Ut())===12.2&&Z("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(t){return m("SimpleDb","Removing database:",t),ot(window.indexedDB.deleteDatabase(t)).toPromise()}static D(){if(!Ur())return!1;if(r.C())return!0;let t=Ut(),e=r.S(t),n=0<e&&e<10,s=r.v(t),i=0<s&&s<4.5;return!(t.indexOf("MSIE ")>0||t.indexOf("Trident/")>0||t.indexOf("Edge/")>0||n||i)}static C(){var t;return typeof process<"u"&&((t=process.__PRIVATE_env)===null||t===void 0?void 0:t.F)==="YES"}static M(t,e){return t.store(e)}static S(t){let e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static v(t){let e=t.match(/Android ([\d.]+)/i),n=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(n)}O(t){return p(this,null,function*(){return this.db||(m("SimpleDb","Opening database:",this.name),this.db=yield new Promise((e,n)=>{let s=indexedDB.open(this.name,this.version);s.onsuccess=i=>{let o=i.target.result;e(o)},s.onblocked=()=>{n(new ct(t,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},s.onerror=i=>{let o=i.target.error;o.name==="VersionError"?n(new y(f.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):o.name==="InvalidStateError"?n(new y(f.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+o)):n(new ct(t,o))},s.onupgradeneeded=i=>{m("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',i.oldVersion);let o=i.target.result;this.p.N(o,s.transaction,i.oldVersion,this.version).next(()=>{m("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.B&&(this.db.onversionchange=e=>this.B(e)),this.db})}L(t){this.B=t,this.db&&(this.db.onversionchange=e=>t(e))}runTransaction(t,e,n,s){return p(this,null,function*(){let i=e==="readonly",o=0;for(;;){++o;try{this.db=yield this.O(t);let a=nn.open(this.db,t,i?"readonly":"readwrite",n),c=s(a).next(u=>(a.g(),u)).catch(u=>(a.abort(u),h.reject(u))).toPromise();return c.catch(()=>{}),yield a.m,c}catch(a){let c=a,u=c.name!=="FirebaseError"&&o<3;if(m("SimpleDb","Transaction failed with error:",c.message,"Retrying:",u),this.close(),!u)return Promise.reject(c)}}})}close(){this.db&&this.db.close(),this.db=void 0}},rn=class{constructor(t){this.k=t,this.q=!1,this.K=null}get isDone(){return this.q}get $(){return this.K}set cursor(t){this.k=t}done(){this.q=!0}U(t){this.K=t}delete(){return ot(this.k.delete())}},ct=class extends y{constructor(t,e){super(f.UNAVAILABLE,`IndexedDB transaction '${t}' failed: ${e}`),this.name="IndexedDbTransactionError"}};function Ae(r){return r.name==="IndexedDbTransactionError"}var sn=class{constructor(t){this.store=t}put(t,e){let n;return e!==void 0?(m("SimpleDb","PUT",this.store.name,t,e),n=this.store.put(e,t)):(m("SimpleDb","PUT",this.store.name,"<auto-key>",t),n=this.store.put(t)),ot(n)}add(t){return m("SimpleDb","ADD",this.store.name,t,t),ot(this.store.add(t))}get(t){return ot(this.store.get(t)).next(e=>(e===void 0&&(e=null),m("SimpleDb","GET",this.store.name,t,e),e))}delete(t){return m("SimpleDb","DELETE",this.store.name,t),ot(this.store.delete(t))}count(){return m("SimpleDb","COUNT",this.store.name),ot(this.store.count())}W(t,e){let n=this.options(t,e),s=n.index?this.store.index(n.index):this.store;if(typeof s.getAll=="function"){let i=s.getAll(n.range);return new h((o,a)=>{i.onerror=c=>{a(c.target.error)},i.onsuccess=c=>{o(c.target.result)}})}{let i=this.cursor(n),o=[];return this.G(i,(a,c)=>{o.push(c)}).next(()=>o)}}j(t,e){let n=this.store.getAll(t,e===null?void 0:e);return new h((s,i)=>{n.onerror=o=>{i(o.target.error)},n.onsuccess=o=>{s(o.target.result)}})}H(t,e){m("SimpleDb","DELETE ALL",this.store.name);let n=this.options(t,e);n.J=!1;let s=this.cursor(n);return this.G(s,(i,o,a)=>a.delete())}Y(t,e){let n;e?n=t:(n={},e=t);let s=this.cursor(n);return this.G(s,e)}Z(t){let e=this.cursor({});return new h((n,s)=>{e.onerror=i=>{let o=hr(i.target.error);s(o)},e.onsuccess=i=>{let o=i.target.result;o?t(o.primaryKey,o.value).next(a=>{a?o.continue():n()}):n()}})}G(t,e){let n=[];return new h((s,i)=>{t.onerror=o=>{i(o.target.error)},t.onsuccess=o=>{let a=o.target.result;if(!a)return void s();let c=new rn(a),u=e(a.primaryKey,a.value,c);if(u instanceof h){let l=u.catch(d=>(c.done(),h.reject(d)));n.push(l)}c.isDone?s():c.$===null?a.continue():a.continue(c.$)}}).next(()=>h.waitFor(n))}options(t,e){let n;return t!==void 0&&(typeof t=="string"?n=t:e=t),{index:n,range:e}}cursor(t){let e="next";if(t.reverse&&(e="prev"),t.index){let n=this.store.index(t.index);return t.J?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)}};function ot(r){return new h((t,e)=>{r.onsuccess=n=>{let s=n.target.result;t(s)},r.onerror=n=>{let s=hr(n.target.error);e(s)}})}var as=!1;function hr(r){let t=he.S(Ut());if(t>=12.2&&t<13){let e="An internal error was encountered in the Indexed Database server";if(r.message.indexOf(e)>=0){let n=new y("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${e}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return as||(as=!0,setTimeout(()=>{throw n},0)),n}}return r}var di=(()=>{class r{constructor(e,n){this.previousValue=e,n&&(n.sequenceNumberHandler=s=>this.se(s),this.oe=s=>n.writeSequenceNumber(s))}se(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){let e=++this.previousValue;return this.oe&&this.oe(e),e}}return r._e=-1,r})();function dr(r){return r==null}function de(r){return r===0&&1/r==-1/0}var fi=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],Yo=[...fi,"documentOverlays"],mi=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],gi=mi,Jo=[...gi,"indexConfiguration","indexState","indexEntries"];function cs(r){let t=0;for(let e in r)Object.prototype.hasOwnProperty.call(r,e)&&t++;return t}function be(r,t){for(let e in r)Object.prototype.hasOwnProperty.call(r,e)&&t(e,r[e])}function pi(r){for(let t in r)if(Object.prototype.hasOwnProperty.call(r,t))return!1;return!0}var q=class r{constructor(t,e){this.comparator=t,this.root=e||Q.EMPTY}insert(t,e){return new r(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,Q.BLACK,null,null))}remove(t){return new r(this.comparator,this.root.remove(t,this.comparator).copy(null,null,Q.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){let n=this.comparator(t,e.key);if(n===0)return e.value;n<0?e=e.left:n>0&&(e=e.right)}return null}indexOf(t){let e=0,n=this.root;for(;!n.isEmpty();){let s=this.comparator(t,n.key);if(s===0)return e+n.left.size;s<0?n=n.left:(e+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(t){this.inorderTraversal((e,n)=>(t(e,n),!1))}toString(){let t=[];return this.inorderTraversal((e,n)=>(t.push(`${e}:${n}`),!1)),`{${t.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new wt(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new wt(this.root,t,this.comparator,!1)}getReverseIterator(){return new wt(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new wt(this.root,t,this.comparator,!0)}},wt=class{constructor(t,e,n,s){this.isReverse=s,this.nodeStack=[];let i=1;for(;!t.isEmpty();)if(i=e?n(t.key,e):1,e&&s&&(i*=-1),i<0)t=this.isReverse?t.left:t.right;else{if(i===0){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop(),e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return this.nodeStack.length>0}peek(){if(this.nodeStack.length===0)return null;let t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}},Q=class r{constructor(t,e,n,s,i){this.key=t,this.value=e,this.color=n??r.RED,this.left=s??r.EMPTY,this.right=i??r.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,n,s,i){return new r(t??this.key,e??this.value,n??this.color,s??this.left,i??this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,n){let s=this,i=n(t,s.key);return s=i<0?s.copy(null,null,null,s.left.insert(t,e,n),null):i===0?s.copy(null,e,null,null,null):s.copy(null,null,null,null,s.right.insert(t,e,n)),s.fixUp()}removeMin(){if(this.left.isEmpty())return r.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let n,s=this;if(e(t,s.key)<0)s.left.isEmpty()||s.left.isRed()||s.left.left.isRed()||(s=s.moveRedLeft()),s=s.copy(null,null,null,s.left.remove(t,e),null);else{if(s.left.isRed()&&(s=s.rotateRight()),s.right.isEmpty()||s.right.isRed()||s.right.left.isRed()||(s=s.moveRedRight()),e(t,s.key)===0){if(s.right.isEmpty())return r.EMPTY;n=s.right.min(),s=s.copy(n.key,n.value,null,null,s.right.removeMin())}s=s.copy(null,null,null,null,s.right.remove(t,e))}return s.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){let t=this.copy(null,null,r.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){let t=this.copy(null,null,r.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){let t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){let t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed()||this.right.isRed())throw w();let t=this.left.check();if(t!==this.right.check())throw w();return t+(this.isRed()?0:1)}};Q.EMPTY=null,Q.RED=!0,Q.BLACK=!1;Q.EMPTY=new class{constructor(){this.size=0}get key(){throw w()}get value(){throw w()}get color(){throw w()}get left(){throw w()}get right(){throw w()}copy(t,e,n,s,i){return this}insert(t,e,n){return new Q(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};var O=class r{constructor(t){this.comparator=t,this.data=new q(this.comparator)}has(t){return this.data.get(t)!==null}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(t){this.data.inorderTraversal((e,n)=>(t(e),!1))}forEachInRange(t,e){let n=this.data.getIteratorFrom(t[0]);for(;n.hasNext();){let s=n.getNext();if(this.comparator(s.key,t[1])>=0)return;e(s.key)}}forEachWhile(t,e){let n;for(n=e!==void 0?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();)if(!t(n.getNext().key))return}firstAfterOrEqual(t){let e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new fe(this.data.getIterator())}getIteratorFrom(t){return new fe(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach(n=>{e=e.add(n)}),e}isEqual(t){if(!(t instanceof r)||this.size!==t.size)return!1;let e=this.data.getIterator(),n=t.data.getIterator();for(;e.hasNext();){let s=e.getNext().key,i=n.getNext().key;if(this.comparator(s,i)!==0)return!1}return!0}toArray(){let t=[];return this.forEach(e=>{t.push(e)}),t}toString(){let t=[];return this.forEach(e=>t.push(e)),"SortedSet("+t.toString()+")"}copy(t){let e=new r(this.comparator);return e.data=t,e}},fe=class{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}};var X=class r{constructor(t){this.fields=t,t.sort(G.comparator)}static empty(){return new r([])}unionWith(t){let e=new O(G.comparator);for(let n of this.fields)e=e.add(n);for(let n of t)e=e.add(n);return new r(e.toArray())}covers(t){for(let e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return Et(this.fields,t.fields,(e,n)=>e.isEqual(n))}};var on=class extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}};var Tt=class r{constructor(t){this.binaryString=t}static fromBase64String(t){let e=function(s){try{return atob(s)}catch(i){throw typeof DOMException<"u"&&i instanceof DOMException?new on("Invalid base64 string: "+i):i}}(t);return new r(e)}static fromUint8Array(t){let e=function(s){let i="";for(let o=0;o<s.length;++o)i+=String.fromCharCode(s[o]);return i}(t);return new r(e)}[Symbol.iterator](){let t=0;return{next:()=>t<this.binaryString.length?{value:this.binaryString.charCodeAt(t++),done:!1}:{value:void 0,done:!0}}}toBase64(){return function(e){return btoa(e)}(this.binaryString)}toUint8Array(){return function(e){let n=new Uint8Array(e.length);for(let s=0;s<e.length;s++)n[s]=e.charCodeAt(s);return n}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return A(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}};Tt.EMPTY_BYTE_STRING=new Tt("");var _i=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function ft(r){if(C(!!r),typeof r=="string"){let t=0,e=_i.exec(r);if(C(!!e),e[1]){let s=e[1];s=(s+"000000000").substr(0,9),t=Number(s)}let n=new Date(r);return{seconds:Math.floor(n.getTime()/1e3),nanos:t}}return{seconds:D(r.seconds),nanos:D(r.nanos)}}function D(r){return typeof r=="number"?r:typeof r=="string"?Number(r):0}function vt(r){return typeof r=="string"?Tt.fromBase64String(r):Tt.fromUint8Array(r)}function fr(r){var t,e;return((e=(((t=r?.mapValue)===null||t===void 0?void 0:t.fields)||{}).__type__)===null||e===void 0?void 0:e.stringValue)==="server_timestamp"}function As(r){let t=r.mapValue.fields.__previous_value__;return fr(t)?As(t):t}function me(r){let t=ft(r.mapValue.fields.__local_write_time__.timestampValue);return new U(t.seconds,t.nanos)}var an=class{constructor(t,e,n,s,i,o,a,c,u){this.databaseId=t,this.appId=e,this.persistenceKey=n,this.host=s,this.ssl=i,this.forceLongPolling=o,this.autoDetectLongPolling=a,this.longPollingOptions=c,this.useFetchStreams=u}},cn=class r{constructor(t,e){this.projectId=t,this.database=e||"(default)"}static empty(){return new r("","")}get isDefaultDatabase(){return this.database==="(default)"}isEqual(t){return t instanceof r&&t.projectId===this.projectId&&t.database===this.database}};var ie={mapValue:{fields:{__type__:{stringValue:"__max__"}}}};function At(r){return"nullValue"in r?0:"booleanValue"in r?1:"integerValue"in r||"doubleValue"in r?2:"timestampValue"in r?3:"stringValue"in r?5:"bytesValue"in r?6:"referenceValue"in r?7:"geoPointValue"in r?8:"arrayValue"in r?9:"mapValue"in r?fr(r)?4:bs(r)?9007199254740991:10:w()}function $(r,t){if(r===t)return!0;let e=At(r);if(e!==At(t))return!1;switch(e){case 0:case 9007199254740991:return!0;case 1:return r.booleanValue===t.booleanValue;case 4:return me(r).isEqual(me(t));case 3:return function(s,i){if(typeof s.timestampValue=="string"&&typeof i.timestampValue=="string"&&s.timestampValue.length===i.timestampValue.length)return s.timestampValue===i.timestampValue;let o=ft(s.timestampValue),a=ft(i.timestampValue);return o.seconds===a.seconds&&o.nanos===a.nanos}(r,t);case 5:return r.stringValue===t.stringValue;case 6:return function(s,i){return vt(s.bytesValue).isEqual(vt(i.bytesValue))}(r,t);case 7:return r.referenceValue===t.referenceValue;case 8:return function(s,i){return D(s.geoPointValue.latitude)===D(i.geoPointValue.latitude)&&D(s.geoPointValue.longitude)===D(i.geoPointValue.longitude)}(r,t);case 2:return function(s,i){if("integerValue"in s&&"integerValue"in i)return D(s.integerValue)===D(i.integerValue);if("doubleValue"in s&&"doubleValue"in i){let o=D(s.doubleValue),a=D(i.doubleValue);return o===a?de(o)===de(a):isNaN(o)&&isNaN(a)}return!1}(r,t);case 9:return Et(r.arrayValue.values||[],t.arrayValue.values||[],$);case 10:return function(s,i){let o=s.mapValue.fields||{},a=i.mapValue.fields||{};if(cs(o)!==cs(a))return!1;for(let c in o)if(o.hasOwnProperty(c)&&(a[c]===void 0||!$(o[c],a[c])))return!1;return!0}(r,t);default:return w()}}function Yt(r,t){return(r.values||[]).find(e=>$(e,t))!==void 0}function bt(r,t){if(r===t)return 0;let e=At(r),n=At(t);if(e!==n)return A(e,n);switch(e){case 0:case 9007199254740991:return 0;case 1:return A(r.booleanValue,t.booleanValue);case 2:return function(i,o){let a=D(i.integerValue||i.doubleValue),c=D(o.integerValue||o.doubleValue);return a<c?-1:a>c?1:a===c?0:isNaN(a)?isNaN(c)?0:-1:1}(r,t);case 3:return us(r.timestampValue,t.timestampValue);case 4:return us(me(r),me(t));case 5:return A(r.stringValue,t.stringValue);case 6:return function(i,o){let a=vt(i),c=vt(o);return a.compareTo(c)}(r.bytesValue,t.bytesValue);case 7:return function(i,o){let a=i.split("/"),c=o.split("/");for(let u=0;u<a.length&&u<c.length;u++){let l=A(a[u],c[u]);if(l!==0)return l}return A(a.length,c.length)}(r.referenceValue,t.referenceValue);case 8:return function(i,o){let a=A(D(i.latitude),D(o.latitude));return a!==0?a:A(D(i.longitude),D(o.longitude))}(r.geoPointValue,t.geoPointValue);case 9:return function(i,o){let a=i.values||[],c=o.values||[];for(let u=0;u<a.length&&u<c.length;++u){let l=bt(a[u],c[u]);if(l)return l}return A(a.length,c.length)}(r.arrayValue,t.arrayValue);case 10:return function(i,o){if(i===ie.mapValue&&o===ie.mapValue)return 0;if(i===ie.mapValue)return 1;if(o===ie.mapValue)return-1;let a=i.fields||{},c=Object.keys(a),u=o.fields||{},l=Object.keys(u);c.sort(),l.sort();for(let d=0;d<c.length&&d<l.length;++d){let g=A(c[d],l[d]);if(g!==0)return g;let _=bt(a[c[d]],u[l[d]]);if(_!==0)return _}return A(c.length,l.length)}(r.mapValue,t.mapValue);default:throw w()}}function us(r,t){if(typeof r=="string"&&typeof t=="string"&&r.length===t.length)return A(r,t);let e=ft(r),n=ft(t),s=A(e.seconds,n.seconds);return s!==0?s:A(e.nanos,n.nanos)}function St(r){return un(r)}function un(r){return"nullValue"in r?"null":"booleanValue"in r?""+r.booleanValue:"integerValue"in r?""+r.integerValue:"doubleValue"in r?""+r.doubleValue:"timestampValue"in r?function(e){let n=ft(e);return`time(${n.seconds},${n.nanos})`}(r.timestampValue):"stringValue"in r?r.stringValue:"bytesValue"in r?function(e){return vt(e).toBase64()}(r.bytesValue):"referenceValue"in r?function(e){return E.fromName(e).toString()}(r.referenceValue):"geoPointValue"in r?function(e){return`geo(${e.latitude},${e.longitude})`}(r.geoPointValue):"arrayValue"in r?function(e){let n="[",s=!0;for(let i of e.values||[])s?s=!1:n+=",",n+=un(i);return n+"]"}(r.arrayValue):"mapValue"in r?function(e){let n=Object.keys(e.fields||{}).sort(),s="{",i=!0;for(let o of n)i?i=!1:s+=",",s+=`${o}:${un(e.fields[o])}`;return s+"}"}(r.mapValue):w()}function ln(r){return!!r&&"integerValue"in r}function mr(r){return!!r&&"arrayValue"in r}function ce(r){return!!r&&"mapValue"in r}function $t(r){if(r.geoPointValue)return{geoPointValue:Object.assign({},r.geoPointValue)};if(r.timestampValue&&typeof r.timestampValue=="object")return{timestampValue:Object.assign({},r.timestampValue)};if(r.mapValue){let t={mapValue:{fields:{}}};return be(r.mapValue.fields,(e,n)=>t.mapValue.fields[e]=$t(n)),t}if(r.arrayValue){let t={arrayValue:{values:[]}};for(let e=0;e<(r.arrayValue.values||[]).length;++e)t.arrayValue.values[e]=$t(r.arrayValue.values[e]);return t}return Object.assign({},r)}function bs(r){return(((r.mapValue||{}).fields||{}).__type__||{}).stringValue==="__max__"}var H=class r{constructor(t){this.value=t}static empty(){return new r({mapValue:{}})}field(t){if(t.isEmpty())return this.value;{let e=this.value;for(let n=0;n<t.length-1;++n)if(e=(e.mapValue.fields||{})[t.get(n)],!ce(e))return null;return e=(e.mapValue.fields||{})[t.lastSegment()],e||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=$t(e)}setAll(t){let e=G.emptyPath(),n={},s=[];t.forEach((o,a)=>{if(!e.isImmediateParentOf(a)){let c=this.getFieldsMap(e);this.applyChanges(c,n,s),n={},s=[],e=a.popLast()}o?n[a.lastSegment()]=$t(o):s.push(a.lastSegment())});let i=this.getFieldsMap(e);this.applyChanges(i,n,s)}delete(t){let e=this.field(t.popLast());ce(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return $(this.value,t.value)}getFieldsMap(t){let e=this.value;e.mapValue.fields||(e.mapValue={fields:{}});for(let n=0;n<t.length;++n){let s=e.mapValue.fields[t.get(n)];ce(s)&&s.mapValue.fields||(s={mapValue:{fields:{}}},e.mapValue.fields[t.get(n)]=s),e=s}return e.mapValue.fields}applyChanges(t,e,n){be(e,(s,i)=>t[s]=i);for(let s of n)delete t[s]}clone(){return new r($t(this.value))}};function Ss(r){let t=[];return be(r.fields,(e,n)=>{let s=new G([e]);if(ce(n)){let i=Ss(n.mapValue).fields;if(i.length===0)t.push(s);else for(let o of i)t.push(s.child(o))}else t.push(s)}),new X(t)}var Rt=class r{constructor(t,e,n,s,i,o,a){this.key=t,this.documentType=e,this.version=n,this.readTime=s,this.createTime=i,this.data=o,this.documentState=a}static newInvalidDocument(t){return new r(t,0,S.min(),S.min(),S.min(),H.empty(),0)}static newFoundDocument(t,e,n,s){return new r(t,1,e,S.min(),n,s,0)}static newNoDocument(t,e){return new r(t,2,e,S.min(),S.min(),H.empty(),0)}static newUnknownDocument(t,e){return new r(t,3,e,S.min(),S.min(),H.empty(),2)}convertToFoundDocument(t,e){return!this.createTime.isEqual(S.min())||this.documentType!==2&&this.documentType!==0||(this.createTime=t),this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=H.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=H.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=S.min(),this}setReadTime(t){return this.readTime=t,this}get hasLocalMutations(){return this.documentState===1}get hasCommittedMutations(){return this.documentState===2}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return this.documentType!==0}isFoundDocument(){return this.documentType===1}isNoDocument(){return this.documentType===2}isUnknownDocument(){return this.documentType===3}isEqual(t){return t instanceof r&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}mutableCopy(){return new r(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}};var Pt=class{constructor(t,e){this.position=t,this.inclusive=e}};function ls(r,t,e){let n=0;for(let s=0;s<r.position.length;s++){let i=t[s],o=r.position[s];if(i.field.isKeyField()?n=E.comparator(E.fromName(o.referenceValue),e.key):n=bt(o,e.data.field(i.field)),i.dir==="desc"&&(n*=-1),n!==0)break}return n}function hs(r,t){if(r===null)return t===null;if(t===null||r.inclusive!==t.inclusive||r.position.length!==t.position.length)return!1;for(let e=0;e<r.position.length;e++)if(!$(r.position[e],t.position[e]))return!1;return!0}var Vt=class{constructor(t,e="asc"){this.field=t,this.dir=e}};function yi(r,t){return r.dir===t.dir&&r.field.isEqual(t.field)}var ge=class{},x=class r extends ge{constructor(t,e,n){super(),this.field=t,this.op=e,this.value=n}static create(t,e,n){return t.isKeyField()?e==="in"||e==="not-in"?this.createKeyFieldInFilter(t,e,n):new dn(t,e,n):e==="array-contains"?new gn(t,n):e==="in"?new pn(t,n):e==="not-in"?new _n(t,n):e==="array-contains-any"?new yn(t,n):new r(t,e,n)}static createKeyFieldInFilter(t,e,n){return e==="in"?new fn(t,n):new mn(t,n)}matches(t){let e=t.data.field(this.field);return this.op==="!="?e!==null&&this.matchesComparison(bt(e,this.value)):e!==null&&At(this.value)===At(e)&&this.matchesComparison(bt(e,this.value))}matchesComparison(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return t===0;case"!=":return t!==0;case">":return t>0;case">=":return t>=0;default:return w()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}},tt=class r extends ge{constructor(t,e){super(),this.filters=t,this.op=e,this.ue=null}static create(t,e){return new r(t,e)}matches(t){return Rs(this)?this.filters.find(e=>!e.matches(t))===void 0:this.filters.find(e=>e.matches(t))!==void 0}getFlattenedFilters(){return this.ue!==null||(this.ue=this.filters.reduce((t,e)=>t.concat(e.getFlattenedFilters()),[])),this.ue}getFilters(){return Object.assign([],this.filters)}};function Rs(r){return r.op==="and"}function Ps(r){return wi(r)&&Rs(r)}function wi(r){for(let t of r.filters)if(t instanceof tt)return!1;return!0}function hn(r){if(r instanceof x)return r.field.canonicalString()+r.op.toString()+St(r.value);if(Ps(r))return r.filters.map(t=>hn(t)).join(",");{let t=r.filters.map(e=>hn(e)).join(",");return`${r.op}(${t})`}}function Vs(r,t){return r instanceof x?function(n,s){return s instanceof x&&n.op===s.op&&n.field.isEqual(s.field)&&$(n.value,s.value)}(r,t):r instanceof tt?function(n,s){return s instanceof tt&&n.op===s.op&&n.filters.length===s.filters.length?n.filters.reduce((i,o,a)=>i&&Vs(o,s.filters[a]),!0):!1}(r,t):void w()}function Ds(r){return r instanceof x?function(e){return`${e.field.canonicalString()} ${e.op} ${St(e.value)}`}(r):r instanceof tt?function(e){return e.op.toString()+" {"+e.getFilters().map(Ds).join(" ,")+"}"}(r):"Filter"}var dn=class extends x{constructor(t,e,n){super(t,e,n),this.key=E.fromName(n.referenceValue)}matches(t){let e=E.comparator(t.key,this.key);return this.matchesComparison(e)}},fn=class extends x{constructor(t,e){super(t,"in",e),this.keys=xs("in",e)}matches(t){return this.keys.some(e=>e.isEqual(t.key))}},mn=class extends x{constructor(t,e){super(t,"not-in",e),this.keys=xs("not-in",e)}matches(t){return!this.keys.some(e=>e.isEqual(t.key))}};function xs(r,t){var e;return(((e=t.arrayValue)===null||e===void 0?void 0:e.values)||[]).map(n=>E.fromName(n.referenceValue))}var gn=class extends x{constructor(t,e){super(t,"array-contains",e)}matches(t){let e=t.data.field(this.field);return mr(e)&&Yt(e.arrayValue,this.value)}},pn=class extends x{constructor(t,e){super(t,"in",e)}matches(t){let e=t.data.field(this.field);return e!==null&&Yt(this.value.arrayValue,e)}},_n=class extends x{constructor(t,e){super(t,"not-in",e)}matches(t){if(Yt(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;let e=t.data.field(this.field);return e!==null&&!Yt(this.value.arrayValue,e)}},yn=class extends x{constructor(t,e){super(t,"array-contains-any",e)}matches(t){let e=t.data.field(this.field);return!(!mr(e)||!e.arrayValue.values)&&e.arrayValue.values.some(n=>Yt(this.value.arrayValue,n))}};var wn=class{constructor(t,e=null,n=[],s=[],i=null,o=null,a=null){this.path=t,this.collectionGroup=e,this.orderBy=n,this.filters=s,this.limit=i,this.startAt=o,this.endAt=a,this.ce=null}};function ds(r,t=null,e=[],n=[],s=null,i=null,o=null){return new wn(r,t,e,n,s,i,o)}function gr(r){let t=v(r);if(t.ce===null){let e=t.path.canonicalString();t.collectionGroup!==null&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map(n=>hn(n)).join(","),e+="|ob:",e+=t.orderBy.map(n=>function(i){return i.field.canonicalString()+i.dir}(n)).join(","),dr(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map(n=>St(n)).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map(n=>St(n)).join(",")),t.ce=e}return t.ce}function pr(r,t){if(r.limit!==t.limit||r.orderBy.length!==t.orderBy.length)return!1;for(let e=0;e<r.orderBy.length;e++)if(!yi(r.orderBy[e],t.orderBy[e]))return!1;if(r.filters.length!==t.filters.length)return!1;for(let e=0;e<r.filters.length;e++)if(!Vs(r.filters[e],t.filters[e]))return!1;return r.collectionGroup===t.collectionGroup&&!!r.path.isEqual(t.path)&&!!hs(r.startAt,t.startAt)&&hs(r.endAt,t.endAt)}var Jt=class{constructor(t,e=null,n=[],s=[],i=null,o="F",a=null,c=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=s,this.limit=i,this.limitType=o,this.startAt=a,this.endAt=c,this.le=null,this.he=null,this.Pe=null,this.startAt,this.endAt}};function Ii(r,t,e,n,s,i,o,a){return new Jt(r,t,e,n,s,i,o,a)}function fs(r){return r.filters.length===0&&r.limit===null&&r.startAt==null&&r.endAt==null&&(r.explicitOrderBy.length===0||r.explicitOrderBy.length===1&&r.explicitOrderBy[0].field.isKeyField())}function Ei(r){return r.collectionGroup!==null}function jt(r){let t=v(r);if(t.le===null){t.le=[];let e=new Set;for(let i of t.explicitOrderBy)t.le.push(i),e.add(i.field.canonicalString());let n=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc";(function(o){let a=new O(G.comparator);return o.filters.forEach(c=>{c.getFlattenedFilters().forEach(u=>{u.isInequality()&&(a=a.add(u.field))})}),a})(t).forEach(i=>{e.has(i.canonicalString())||i.isKeyField()||t.le.push(new Vt(i,n))}),e.has(G.keyField().canonicalString())||t.le.push(new Vt(G.keyField(),n))}return t.le}function ut(r){let t=v(r);return t.he||(t.he=Ti(t,jt(r))),t.he}function Ti(r,t){if(r.limitType==="F")return ds(r.path,r.collectionGroup,t,r.filters,r.limit,r.startAt,r.endAt);{t=t.map(s=>{let i=s.dir==="desc"?"asc":"desc";return new Vt(s.field,i)});let e=r.endAt?new Pt(r.endAt.position,r.endAt.inclusive):null,n=r.startAt?new Pt(r.startAt.position,r.startAt.inclusive):null;return ds(r.path,r.collectionGroup,t,r.filters,r.limit,e,n)}}function In(r,t,e){return new Jt(r.path,r.collectionGroup,r.explicitOrderBy.slice(),r.filters.slice(),t,e,r.startAt,r.endAt)}function Cs(r,t){return pr(ut(r),ut(t))&&r.limitType===t.limitType}function Ns(r){return`${gr(ut(r))}|lt:${r.limitType}`}function Qt(r){return`Query(target=${function(e){let n=e.path.canonicalString();return e.collectionGroup!==null&&(n+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(n+=`, filters: [${e.filters.map(s=>Ds(s)).join(", ")}]`),dr(e.limit)||(n+=", limit: "+e.limit),e.orderBy.length>0&&(n+=`, orderBy: [${e.orderBy.map(s=>function(o){return`${o.field.canonicalString()} (${o.dir})`}(s)).join(", ")}]`),e.startAt&&(n+=", startAt: ",n+=e.startAt.inclusive?"b:":"a:",n+=e.startAt.position.map(s=>St(s)).join(",")),e.endAt&&(n+=", endAt: ",n+=e.endAt.inclusive?"a:":"b:",n+=e.endAt.position.map(s=>St(s)).join(",")),`Target(${n})`}(ut(r))}; limitType=${r.limitType})`}function _r(r,t){return t.isFoundDocument()&&function(n,s){let i=s.key.path;return n.collectionGroup!==null?s.key.hasCollectionId(n.collectionGroup)&&n.path.isPrefixOf(i):E.isDocumentKey(n.path)?n.path.isEqual(i):n.path.isImmediateParentOf(i)}(r,t)&&function(n,s){for(let i of jt(n))if(!i.field.isKeyField()&&s.data.field(i.field)===null)return!1;return!0}(r,t)&&function(n,s){for(let i of n.filters)if(!i.matches(s))return!1;return!0}(r,t)&&function(n,s){return!(n.startAt&&!function(o,a,c){let u=ls(o,a,c);return o.inclusive?u<=0:u<0}(n.startAt,jt(n),s)||n.endAt&&!function(o,a,c){let u=ls(o,a,c);return o.inclusive?u>=0:u>0}(n.endAt,jt(n),s))}(r,t)}function vi(r){return(t,e)=>{let n=!1;for(let s of jt(r)){let i=Ai(s,t,e);if(i!==0)return i;n=n||s.field.isKeyField()}return 0}}function Ai(r,t,e){let n=r.field.isKeyField()?E.comparator(t.key,e.key):function(i,o,a){let c=o.data.field(i),u=a.data.field(i);return c!==null&&u!==null?bt(c,u):w()}(r.field,t,e);switch(r.dir){case"asc":return n;case"desc":return-1*n;default:return w()}}var et=class{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={},this.innerSize=0}get(t){let e=this.mapKeyFn(t),n=this.inner[e];if(n!==void 0){for(let[s,i]of n)if(this.equalsFn(s,t))return i}}has(t){return this.get(t)!==void 0}set(t,e){let n=this.mapKeyFn(t),s=this.inner[n];if(s===void 0)return this.inner[n]=[[t,e]],void this.innerSize++;for(let i=0;i<s.length;i++)if(this.equalsFn(s[i][0],t))return void(s[i]=[t,e]);s.push([t,e]),this.innerSize++}delete(t){let e=this.mapKeyFn(t),n=this.inner[e];if(n===void 0)return!1;for(let s=0;s<n.length;s++)if(this.equalsFn(n[s][0],t))return n.length===1?delete this.inner[e]:n.splice(s,1),this.innerSize--,!0;return!1}forEach(t){be(this.inner,(e,n)=>{for(let[s,i]of n)t(s,i)})}isEmpty(){return pi(this.inner)}size(){return this.innerSize}};var bi=new q(E.comparator);function pe(){return bi}var ks=new q(E.comparator);function oe(...r){let t=ks;for(let e of r)t=t.insert(e.key,e);return t}function Fs(r){let t=ks;return r.forEach((e,n)=>t=t.insert(e,n.overlayedDocument)),t}function at(){return Wt()}function Ms(){return Wt()}function Wt(){return new et(r=>r.toString(),(r,t)=>r.isEqual(t))}var Si=new q(E.comparator),Ri=new O(E.comparator);function M(...r){let t=Ri;for(let e of r)t=t.add(e);return t}var Pi=new O(A);function Vi(){return Pi}function Di(r,t){if(r.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:de(t)?"-0":t}}function xi(r){return{integerValue:""+r}}var Dt=class{constructor(){this._=void 0}};function Ci(r,t,e){return r instanceof xt?function(s,i){let o={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:s.seconds,nanos:s.nanoseconds}}}};return i&&fr(i)&&(i=As(i)),i&&(o.fields.__previous_value__=i),{mapValue:o}}(e,t):r instanceof mt?Os(r,t):r instanceof gt?qs(r,t):function(s,i){let o=Ls(s,i),a=ms(o)+ms(s.Ie);return ln(o)&&ln(s.Ie)?xi(a):Di(s.serializer,a)}(r,t)}function Ni(r,t,e){return r instanceof mt?Os(r,t):r instanceof gt?qs(r,t):e}function Ls(r,t){return r instanceof Ct?function(n){return ln(n)||function(i){return!!i&&"doubleValue"in i}(n)}(t)?t:{integerValue:0}:null}var xt=class extends Dt{},mt=class extends Dt{constructor(t){super(),this.elements=t}};function Os(r,t){let e=Bs(t);for(let n of r.elements)e.some(s=>$(s,n))||e.push(n);return{arrayValue:{values:e}}}var gt=class extends Dt{constructor(t){super(),this.elements=t}};function qs(r,t){let e=Bs(t);for(let n of r.elements)e=e.filter(s=>!$(s,n));return{arrayValue:{values:e}}}var Ct=class extends Dt{constructor(t,e){super(),this.serializer=t,this.Ie=e}};function ms(r){return D(r.integerValue||r.doubleValue)}function Bs(r){return mr(r)&&r.arrayValue.values?r.arrayValue.values.slice():[]}function ki(r,t){return r.field.isEqual(t.field)&&function(n,s){return n instanceof mt&&s instanceof mt||n instanceof gt&&s instanceof gt?Et(n.elements,s.elements,$):n instanceof Ct&&s instanceof Ct?$(n.Ie,s.Ie):n instanceof xt&&s instanceof xt}(r.transform,t.transform)}var En=class{constructor(t,e){this.version=t,this.transformResults=e}},lt=class r{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new r}static exists(t){return new r(void 0,t)}static updateTime(t){return new r(t)}get isNone(){return this.updateTime===void 0&&this.exists===void 0}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}};function ue(r,t){return r.updateTime!==void 0?t.isFoundDocument()&&t.version.isEqual(r.updateTime):r.exists===void 0||r.exists===t.isFoundDocument()}var Nt=class{};function Us(r,t){if(!r.hasLocalMutations||t&&t.fields.length===0)return null;if(t===null)return r.isNoDocument()?new Xt(r.key,lt.none()):new kt(r.key,r.data,lt.none());{let e=r.data,n=H.empty(),s=new O(G.comparator);for(let i of t.fields)if(!s.has(i)){let o=e.field(i);o===null&&i.length>1&&(i=i.popLast(),o=e.field(i)),o===null?n.delete(i):n.set(i,o),s=s.add(i)}return new nt(r.key,n,new X(s.toArray()),lt.none())}}function Fi(r,t,e){r instanceof kt?function(s,i,o){let a=s.value.clone(),c=ps(s.fieldTransforms,i,o.transformResults);a.setAll(c),i.convertToFoundDocument(o.version,a).setHasCommittedMutations()}(r,t,e):r instanceof nt?function(s,i,o){if(!ue(s.precondition,i))return void i.convertToUnknownDocument(o.version);let a=ps(s.fieldTransforms,i,o.transformResults),c=i.data;c.setAll(Gs(s)),c.setAll(a),i.convertToFoundDocument(o.version,c).setHasCommittedMutations()}(r,t,e):function(s,i,o){i.convertToNoDocument(o.version).setHasCommittedMutations()}(0,t,e)}function Ht(r,t,e,n){return r instanceof kt?function(i,o,a,c){if(!ue(i.precondition,o))return a;let u=i.value.clone(),l=_s(i.fieldTransforms,c,o);return u.setAll(l),o.convertToFoundDocument(o.version,u).setHasLocalMutations(),null}(r,t,e,n):r instanceof nt?function(i,o,a,c){if(!ue(i.precondition,o))return a;let u=_s(i.fieldTransforms,c,o),l=o.data;return l.setAll(Gs(i)),l.setAll(u),o.convertToFoundDocument(o.version,l).setHasLocalMutations(),a===null?null:a.unionWith(i.fieldMask.fields).unionWith(i.fieldTransforms.map(d=>d.field))}(r,t,e,n):function(i,o,a){return ue(i.precondition,o)?(o.convertToNoDocument(o.version).setHasLocalMutations(),null):a}(r,t,e)}function Mi(r,t){let e=null;for(let n of r.fieldTransforms){let s=t.data.field(n.field),i=Ls(n.transform,s||null);i!=null&&(e===null&&(e=H.empty()),e.set(n.field,i))}return e||null}function gs(r,t){return r.type===t.type&&!!r.key.isEqual(t.key)&&!!r.precondition.isEqual(t.precondition)&&!!function(n,s){return n===void 0&&s===void 0||!(!n||!s)&&Et(n,s,(i,o)=>ki(i,o))}(r.fieldTransforms,t.fieldTransforms)&&(r.type===0?r.value.isEqual(t.value):r.type!==1||r.data.isEqual(t.data)&&r.fieldMask.isEqual(t.fieldMask))}var kt=class extends Nt{constructor(t,e,n,s=[]){super(),this.key=t,this.value=e,this.precondition=n,this.fieldTransforms=s,this.type=0}getFieldMask(){return null}},nt=class extends Nt{constructor(t,e,n,s,i=[]){super(),this.key=t,this.data=e,this.fieldMask=n,this.precondition=s,this.fieldTransforms=i,this.type=1}getFieldMask(){return this.fieldMask}};function Gs(r){let t=new Map;return r.fieldMask.fields.forEach(e=>{if(!e.isEmpty()){let n=r.data.field(e);t.set(e,n)}}),t}function ps(r,t,e){let n=new Map;C(r.length===e.length);for(let s=0;s<e.length;s++){let i=r[s],o=i.transform,a=t.data.field(i.field);n.set(i.field,Ni(o,a,e[s]))}return n}function _s(r,t,e){let n=new Map;for(let s of r){let i=s.transform,o=e.data.field(s.field);n.set(s.field,Ci(i,o,t))}return n}var Xt=class extends Nt{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}},Tn=class extends Nt{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}};var vn=class{constructor(t,e,n,s){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,this.mutations=s}applyToRemoteDocument(t,e){let n=e.mutationResults;for(let s=0;s<this.mutations.length;s++){let i=this.mutations[s];i.key.isEqual(t.key)&&Fi(i,t,n[s])}}applyToLocalView(t,e){for(let n of this.baseMutations)n.key.isEqual(t.key)&&(e=Ht(n,t,e,this.localWriteTime));for(let n of this.mutations)n.key.isEqual(t.key)&&(e=Ht(n,t,e,this.localWriteTime));return e}applyToLocalDocumentSet(t,e){let n=Ms();return this.mutations.forEach(s=>{let i=t.get(s.key),o=i.overlayedDocument,a=this.applyToLocalView(o,i.mutatedFields);a=e.has(s.key)?null:a;let c=Us(o,a);c!==null&&n.set(s.key,c),o.isValidDocument()||o.convertToNoDocument(S.min())}),n}keys(){return this.mutations.reduce((t,e)=>t.add(e.key),M())}isEqual(t){return this.batchId===t.batchId&&Et(this.mutations,t.mutations,(e,n)=>gs(e,n))&&Et(this.baseMutations,t.baseMutations,(e,n)=>gs(e,n))}},An=class r{constructor(t,e,n,s){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.docVersions=s}static from(t,e,n){C(t.mutations.length===n.length);let s=function(){return Si}(),i=t.mutations;for(let o=0;o<i.length;o++)s=s.insert(i[o].key,n[o].version);return new r(t,e,n,s)}};var bn=class{constructor(t,e){this.largestBatchId=t,this.mutation=e}getKey(){return this.mutation.key}isEqual(t){return t!==null&&this.mutation===t.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}};var R,I;function Li(r){switch(r){default:return w();case f.CANCELLED:case f.UNKNOWN:case f.DEADLINE_EXCEEDED:case f.RESOURCE_EXHAUSTED:case f.INTERNAL:case f.UNAVAILABLE:case f.UNAUTHENTICATED:return!1;case f.INVALID_ARGUMENT:case f.NOT_FOUND:case f.ALREADY_EXISTS:case f.PERMISSION_DENIED:case f.FAILED_PRECONDITION:case f.ABORTED:case f.OUT_OF_RANGE:case f.UNIMPLEMENTED:case f.DATA_LOSS:return!0}}function Oi(r){if(r===void 0)return Z("GRPC error has no .code"),f.UNKNOWN;switch(r){case R.OK:return f.OK;case R.CANCELLED:return f.CANCELLED;case R.UNKNOWN:return f.UNKNOWN;case R.DEADLINE_EXCEEDED:return f.DEADLINE_EXCEEDED;case R.RESOURCE_EXHAUSTED:return f.RESOURCE_EXHAUSTED;case R.INTERNAL:return f.INTERNAL;case R.UNAVAILABLE:return f.UNAVAILABLE;case R.UNAUTHENTICATED:return f.UNAUTHENTICATED;case R.INVALID_ARGUMENT:return f.INVALID_ARGUMENT;case R.NOT_FOUND:return f.NOT_FOUND;case R.ALREADY_EXISTS:return f.ALREADY_EXISTS;case R.PERMISSION_DENIED:return f.PERMISSION_DENIED;case R.FAILED_PRECONDITION:return f.FAILED_PRECONDITION;case R.ABORTED:return f.ABORTED;case R.OUT_OF_RANGE:return f.OUT_OF_RANGE;case R.UNIMPLEMENTED:return f.UNIMPLEMENTED;case R.DATA_LOSS:return f.DATA_LOSS;default:return w()}}(I=R||(R={}))[I.OK=0]="OK",I[I.CANCELLED=1]="CANCELLED",I[I.UNKNOWN=2]="UNKNOWN",I[I.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",I[I.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",I[I.NOT_FOUND=5]="NOT_FOUND",I[I.ALREADY_EXISTS=6]="ALREADY_EXISTS",I[I.PERMISSION_DENIED=7]="PERMISSION_DENIED",I[I.UNAUTHENTICATED=16]="UNAUTHENTICATED",I[I.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",I[I.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",I[I.ABORTED=10]="ABORTED",I[I.OUT_OF_RANGE=11]="OUT_OF_RANGE",I[I.UNIMPLEMENTED=12]="UNIMPLEMENTED",I[I.INTERNAL=13]="INTERNAL",I[I.UNAVAILABLE=14]="UNAVAILABLE",I[I.DATA_LOSS=15]="DATA_LOSS";var Zo=new Jr([4294967295,4294967295],0);var Sn=class{constructor(t,e){this.databaseId=t,this.useProto3Json=e}};function qi(r,t){return r.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function Bi(r,t){return qi(r,t.toTimestamp())}function It(r){return C(!!r),S.fromTimestamp(function(e){let n=ft(e);return new U(n.seconds,n.nanos)}(r))}function Ui(r,t){return Rn(r,t).canonicalString()}function Rn(r,t){let e=function(s){return new F(["projects",s.projectId,"databases",s.database])}(r).child("documents");return t===void 0?e:e.child(t)}function Gi(r){let t=F.fromString(r);return C(Yi(t)),t}function Pn(r,t){return Ui(r.databaseId,t.path)}function zi(r){let t=Gi(r);return t.length===4?F.emptyPath():Qi(t)}function Ki(r){return new F(["projects",r.databaseId.projectId,"databases",r.databaseId.database]).canonicalString()}function Qi(r){return C(r.length>4&&r.get(4)==="documents"),r.popFirst(5)}function ys(r,t,e){return{name:Pn(r,t),fields:e.value.mapValue.fields}}function $i(r,t){let e;if(t instanceof kt)e={update:ys(r,t.key,t.value)};else if(t instanceof Xt)e={delete:Pn(r,t.key)};else if(t instanceof nt)e={update:ys(r,t.key,t.data),updateMask:Hi(t.fieldMask)};else{if(!(t instanceof Tn))return w();e={verify:Pn(r,t.key)}}return t.fieldTransforms.length>0&&(e.updateTransforms=t.fieldTransforms.map(n=>function(i,o){let a=o.transform;if(a instanceof xt)return{fieldPath:o.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(a instanceof mt)return{fieldPath:o.field.canonicalString(),appendMissingElements:{values:a.elements}};if(a instanceof gt)return{fieldPath:o.field.canonicalString(),removeAllFromArray:{values:a.elements}};if(a instanceof Ct)return{fieldPath:o.field.canonicalString(),increment:a.Ie};throw w()}(0,n))),t.precondition.isNone||(e.currentDocument=function(s,i){return i.updateTime!==void 0?{updateTime:Bi(s,i.updateTime)}:i.exists!==void 0?{exists:i.exists}:w()}(r,t.precondition)),e}function ji(r,t){return r&&r.length>0?(C(t!==void 0),r.map(e=>function(s,i){let o=s.updateTime?It(s.updateTime):It(i);return o.isEqual(S.min())&&(o=It(i)),new En(o,s.transformResults||[])}(e,t))):[]}function Wi(r){let t=zi(r.parent),e=r.structuredQuery,n=e.from?e.from.length:0,s=null;if(n>0){C(n===1);let l=e.from[0];l.allDescendants?s=l.collectionId:t=t.child(l.collectionId)}let i=[];e.where&&(i=function(d){let g=zs(d);return g instanceof tt&&Ps(g)?g.getFilters():[g]}(e.where));let o=[];e.orderBy&&(o=function(d){return d.map(g=>function(b){return new Vt(yt(b.field),function(T){switch(T){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(b.direction))}(g))}(e.orderBy));let a=null;e.limit&&(a=function(d){let g;return g=typeof d=="object"?d.value:d,dr(g)?null:g}(e.limit));let c=null;e.startAt&&(c=function(d){let g=!!d.before,_=d.values||[];return new Pt(_,g)}(e.startAt));let u=null;return e.endAt&&(u=function(d){let g=!d.before,_=d.values||[];return new Pt(_,g)}(e.endAt)),Ii(t,s,o,i,a,"F",c,u)}function zs(r){return r.unaryFilter!==void 0?function(e){switch(e.unaryFilter.op){case"IS_NAN":let n=yt(e.unaryFilter.field);return x.create(n,"==",{doubleValue:NaN});case"IS_NULL":let s=yt(e.unaryFilter.field);return x.create(s,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":let i=yt(e.unaryFilter.field);return x.create(i,"!=",{doubleValue:NaN});case"IS_NOT_NULL":let o=yt(e.unaryFilter.field);return x.create(o,"!=",{nullValue:"NULL_VALUE"});default:return w()}}(r):r.fieldFilter!==void 0?function(e){return x.create(yt(e.fieldFilter.field),function(s){switch(s){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return w()}}(e.fieldFilter.op),e.fieldFilter.value)}(r):r.compositeFilter!==void 0?function(e){return tt.create(e.compositeFilter.filters.map(n=>zs(n)),function(s){switch(s){case"AND":return"and";case"OR":return"or";default:return w()}}(e.compositeFilter.op))}(r):w()}function yt(r){return G.fromServerFormat(r.fieldPath)}function Hi(r){let t=[];return r.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}function Yi(r){return r.length>=4&&r.get(0)==="projects"&&r.get(2)==="databases"}var Vn=class{constructor(t){this.ct=t}};function Ji(r){let t=Wi({parent:r.parent,structuredQuery:r.structuredQuery});return r.limitType==="LAST"?In(t,t.limit,"L"):t}var _e=class{constructor(){}Pt(t,e){this.It(t,e),e.Tt()}It(t,e){if("nullValue"in t)this.Et(e,5);else if("booleanValue"in t)this.Et(e,10),e.dt(t.booleanValue?1:0);else if("integerValue"in t)this.Et(e,15),e.dt(D(t.integerValue));else if("doubleValue"in t){let n=D(t.doubleValue);isNaN(n)?this.Et(e,13):(this.Et(e,15),de(n)?e.dt(0):e.dt(n))}else if("timestampValue"in t){let n=t.timestampValue;this.Et(e,20),typeof n=="string"?e.At(n):(e.At(`${n.seconds||""}`),e.dt(n.nanos||0))}else if("stringValue"in t)this.Rt(t.stringValue,e),this.Vt(e);else if("bytesValue"in t)this.Et(e,30),e.ft(vt(t.bytesValue)),this.Vt(e);else if("referenceValue"in t)this.gt(t.referenceValue,e);else if("geoPointValue"in t){let n=t.geoPointValue;this.Et(e,45),e.dt(n.latitude||0),e.dt(n.longitude||0)}else"mapValue"in t?bs(t)?this.Et(e,Number.MAX_SAFE_INTEGER):(this.yt(t.mapValue,e),this.Vt(e)):"arrayValue"in t?(this.wt(t.arrayValue,e),this.Vt(e)):w()}Rt(t,e){this.Et(e,25),this.St(t,e)}St(t,e){e.At(t)}yt(t,e){let n=t.fields||{};this.Et(e,55);for(let s of Object.keys(n))this.Rt(s,e),this.It(n[s],e)}wt(t,e){let n=t.values||[];this.Et(e,50);for(let s of n)this.It(s,e)}gt(t,e){this.Et(e,37),E.fromName(t).path.forEach(n=>{this.Et(e,60),this.St(n,e)})}Et(t,e){t.dt(e)}Vt(t){t.dt(2)}};_e.bt=new _e;var Dn=class{constructor(){this._n=new xn}addToCollectionParentIndex(t,e){return this._n.add(e),h.resolve()}getCollectionParents(t,e){return h.resolve(this._n.getEntries(e))}addFieldIndex(t,e){return h.resolve()}deleteFieldIndex(t,e){return h.resolve()}deleteAllFieldIndexes(t){return h.resolve()}createTargetIndexes(t,e){return h.resolve()}getDocumentsMatchingTarget(t,e){return h.resolve(null)}getIndexType(t,e){return h.resolve(0)}getFieldIndexes(t,e){return h.resolve([])}getNextCollectionGroupToUpdate(t){return h.resolve(null)}getMinOffset(t,e){return h.resolve(dt.min())}getMinOffsetFromCollectionGroup(t,e){return h.resolve(dt.min())}updateCollectionGroup(t,e,n){return h.resolve()}updateIndexEntries(t,e){return h.resolve()}},xn=class{constructor(){this.index={}}add(t){let e=t.lastSegment(),n=t.popLast(),s=this.index[e]||new O(F.comparator),i=!s.has(n);return this.index[e]=s.add(n),i}has(t){let e=t.lastSegment(),n=t.popLast(),s=this.index[e];return s&&s.has(n)}getEntries(t){return(this.index[t]||new O(F.comparator)).toArray()}};var ta=new Uint8Array(0);var z=class r{constructor(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}static withCacheSize(t){return new r(t,r.DEFAULT_COLLECTION_PERCENTILE,r.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}};z.DEFAULT_COLLECTION_PERCENTILE=10,z.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,z.DEFAULT=new z(41943040,z.DEFAULT_COLLECTION_PERCENTILE,z.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),z.DISABLED=new z(-1,0,0);var Zt=class r{constructor(t){this.On=t}next(){return this.On+=2,this.On}static Nn(){return new r(0)}static Bn(){return new r(-1)}};var Cn=class{constructor(){this.changes=new et(t=>t.toString(),(t,e)=>t.isEqual(e)),this.changesApplied=!1}addEntry(t){this.assertNotApplied(),this.changes.set(t.key,t)}removeEntry(t,e){this.assertNotApplied(),this.changes.set(t,Rt.newInvalidDocument(t).setReadTime(e))}getEntry(t,e){this.assertNotApplied();let n=this.changes.get(e);return n!==void 0?h.resolve(n):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}};var Nn=class{constructor(t,e){this.overlayedDocument=t,this.mutatedFields=e}};var kn=class{constructor(t,e,n,s){this.remoteDocumentCache=t,this.mutationQueue=e,this.documentOverlayCache=n,this.indexManager=s}getDocument(t,e){let n=null;return this.documentOverlayCache.getOverlay(t,e).next(s=>(n=s,this.remoteDocumentCache.getEntry(t,e))).next(s=>(n!==null&&Ht(n.mutation,s,X.empty(),U.now()),s))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next(n=>this.getLocalViewOfDocuments(t,n,M()).next(()=>n))}getLocalViewOfDocuments(t,e,n=M()){let s=at();return this.populateOverlays(t,s,e).next(()=>this.computeViews(t,e,s,n).next(i=>{let o=oe();return i.forEach((a,c)=>{o=o.insert(a,c.overlayedDocument)}),o}))}getOverlayedDocuments(t,e){let n=at();return this.populateOverlays(t,n,e).next(()=>this.computeViews(t,e,n,M()))}populateOverlays(t,e,n){let s=[];return n.forEach(i=>{e.has(i)||s.push(i)}),this.documentOverlayCache.getOverlays(t,s).next(i=>{i.forEach((o,a)=>{e.set(o,a)})})}computeViews(t,e,n,s){let i=pe(),o=Wt(),a=function(){return Wt()}();return e.forEach((c,u)=>{let l=n.get(u.key);s.has(u.key)&&(l===void 0||l.mutation instanceof nt)?i=i.insert(u.key,u):l!==void 0?(o.set(u.key,l.mutation.getFieldMask()),Ht(l.mutation,u,l.mutation.getFieldMask(),U.now())):o.set(u.key,X.empty())}),this.recalculateAndSaveOverlays(t,i).next(c=>(c.forEach((u,l)=>o.set(u,l)),e.forEach((u,l)=>{var d;return a.set(u,new Nn(l,(d=o.get(u))!==null&&d!==void 0?d:null))}),a))}recalculateAndSaveOverlays(t,e){let n=Wt(),s=new q((o,a)=>o-a),i=M();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(t,e).next(o=>{for(let a of o)a.keys().forEach(c=>{let u=e.get(c);if(u===null)return;let l=n.get(c)||X.empty();l=a.applyToLocalView(u,l),n.set(c,l);let d=(s.get(a.batchId)||M()).add(c);s=s.insert(a.batchId,d)})}).next(()=>{let o=[],a=s.getReverseIterator();for(;a.hasNext();){let c=a.getNext(),u=c.key,l=c.value,d=Ms();l.forEach(g=>{if(!i.has(g)){let _=Us(e.get(g),n.get(g));_!==null&&d.set(g,_),i=i.add(g)}}),o.push(this.documentOverlayCache.saveOverlays(t,u,d))}return h.waitFor(o)}).next(()=>n)}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next(n=>this.recalculateAndSaveOverlays(t,n))}getDocumentsMatchingQuery(t,e,n,s){return function(o){return E.isDocumentKey(o.path)&&o.collectionGroup===null&&o.filters.length===0}(e)?this.getDocumentsMatchingDocumentQuery(t,e.path):Ei(e)?this.getDocumentsMatchingCollectionGroupQuery(t,e,n,s):this.getDocumentsMatchingCollectionQuery(t,e,n,s)}getNextDocuments(t,e,n,s){return this.remoteDocumentCache.getAllFromCollectionGroup(t,e,n,s).next(i=>{let o=s-i.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(t,e,n.largestBatchId,s-i.size):h.resolve(at()),a=-1,c=i;return o.next(u=>h.forEach(u,(l,d)=>(a<d.largestBatchId&&(a=d.largestBatchId),i.get(l)?h.resolve():this.remoteDocumentCache.getEntry(t,l).next(g=>{c=c.insert(l,g)}))).next(()=>this.populateOverlays(t,u,i)).next(()=>this.computeViews(t,c,u,M())).next(l=>({batchId:a,changes:Fs(l)})))})}getDocumentsMatchingDocumentQuery(t,e){return this.getDocument(t,new E(e)).next(n=>{let s=oe();return n.isFoundDocument()&&(s=s.insert(n.key,n)),s})}getDocumentsMatchingCollectionGroupQuery(t,e,n,s){let i=e.collectionGroup,o=oe();return this.indexManager.getCollectionParents(t,i).next(a=>h.forEach(a,c=>{let u=function(d,g){return new Jt(g,null,d.explicitOrderBy.slice(),d.filters.slice(),d.limit,d.limitType,d.startAt,d.endAt)}(e,c.child(i));return this.getDocumentsMatchingCollectionQuery(t,u,n,s).next(l=>{l.forEach((d,g)=>{o=o.insert(d,g)})})}).next(()=>o))}getDocumentsMatchingCollectionQuery(t,e,n,s){let i;return this.documentOverlayCache.getOverlaysForCollection(t,e.path,n.largestBatchId).next(o=>(i=o,this.remoteDocumentCache.getDocumentsMatchingQuery(t,e,n,i,s))).next(o=>{i.forEach((c,u)=>{let l=u.getKey();o.get(l)===null&&(o=o.insert(l,Rt.newInvalidDocument(l)))});let a=oe();return o.forEach((c,u)=>{let l=i.get(c);l!==void 0&&Ht(l.mutation,u,X.empty(),U.now()),_r(e,u)&&(a=a.insert(c,u))}),a})}};var Fn=class{constructor(t){this.serializer=t,this.cr=new Map,this.lr=new Map}getBundleMetadata(t,e){return h.resolve(this.cr.get(e))}saveBundleMetadata(t,e){return this.cr.set(e.id,function(s){return{id:s.id,version:s.version,createTime:It(s.createTime)}}(e)),h.resolve()}getNamedQuery(t,e){return h.resolve(this.lr.get(e))}saveNamedQuery(t,e){return this.lr.set(e.name,function(s){return{name:s.name,query:Ji(s.bundledQuery),readTime:It(s.readTime)}}(e)),h.resolve()}};var Mn=class{constructor(){this.overlays=new q(E.comparator),this.hr=new Map}getOverlay(t,e){return h.resolve(this.overlays.get(e))}getOverlays(t,e){let n=at();return h.forEach(e,s=>this.getOverlay(t,s).next(i=>{i!==null&&n.set(s,i)})).next(()=>n)}saveOverlays(t,e,n){return n.forEach((s,i)=>{this.ht(t,e,i)}),h.resolve()}removeOverlaysForBatchId(t,e,n){let s=this.hr.get(n);return s!==void 0&&(s.forEach(i=>this.overlays=this.overlays.remove(i)),this.hr.delete(n)),h.resolve()}getOverlaysForCollection(t,e,n){let s=at(),i=e.length+1,o=new E(e.child("")),a=this.overlays.getIteratorFrom(o);for(;a.hasNext();){let c=a.getNext().value,u=c.getKey();if(!e.isPrefixOf(u.path))break;u.path.length===i&&c.largestBatchId>n&&s.set(c.getKey(),c)}return h.resolve(s)}getOverlaysForCollectionGroup(t,e,n,s){let i=new q((u,l)=>u-l),o=this.overlays.getIterator();for(;o.hasNext();){let u=o.getNext().value;if(u.getKey().getCollectionGroup()===e&&u.largestBatchId>n){let l=i.get(u.largestBatchId);l===null&&(l=at(),i=i.insert(u.largestBatchId,l)),l.set(u.getKey(),u)}}let a=at(),c=i.getIterator();for(;c.hasNext()&&(c.getNext().value.forEach((u,l)=>a.set(u,l)),!(a.size()>=s)););return h.resolve(a)}ht(t,e,n){let s=this.overlays.get(n.key);if(s!==null){let o=this.hr.get(s.largestBatchId).delete(n.key);this.hr.set(s.largestBatchId,o)}this.overlays=this.overlays.insert(n.key,new bn(e,n));let i=this.hr.get(e);i===void 0&&(i=M(),this.hr.set(e,i)),this.hr.set(e,i.add(n.key))}};var te=class{constructor(){this.Pr=new O(P.Ir),this.Tr=new O(P.Er)}isEmpty(){return this.Pr.isEmpty()}addReference(t,e){let n=new P(t,e);this.Pr=this.Pr.add(n),this.Tr=this.Tr.add(n)}dr(t,e){t.forEach(n=>this.addReference(n,e))}removeReference(t,e){this.Ar(new P(t,e))}Rr(t,e){t.forEach(n=>this.removeReference(n,e))}Vr(t){let e=new E(new F([])),n=new P(e,t),s=new P(e,t+1),i=[];return this.Tr.forEachInRange([n,s],o=>{this.Ar(o),i.push(o.key)}),i}mr(){this.Pr.forEach(t=>this.Ar(t))}Ar(t){this.Pr=this.Pr.delete(t),this.Tr=this.Tr.delete(t)}gr(t){let e=new E(new F([])),n=new P(e,t),s=new P(e,t+1),i=M();return this.Tr.forEachInRange([n,s],o=>{i=i.add(o.key)}),i}containsKey(t){let e=new P(t,0),n=this.Pr.firstAfterOrEqual(e);return n!==null&&t.isEqual(n.key)}},P=class{constructor(t,e){this.key=t,this.pr=e}static Ir(t,e){return E.comparator(t.key,e.key)||A(t.pr,e.pr)}static Er(t,e){return A(t.pr,e.pr)||E.comparator(t.key,e.key)}};var Ln=class{constructor(t,e){this.indexManager=t,this.referenceDelegate=e,this.mutationQueue=[],this.yr=1,this.wr=new O(P.Ir)}checkEmpty(t){return h.resolve(this.mutationQueue.length===0)}addMutationBatch(t,e,n,s){let i=this.yr;this.yr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];let o=new vn(i,e,n,s);this.mutationQueue.push(o);for(let a of s)this.wr=this.wr.add(new P(a.key,i)),this.indexManager.addToCollectionParentIndex(t,a.key.path.popLast());return h.resolve(o)}lookupMutationBatch(t,e){return h.resolve(this.Sr(e))}getNextMutationBatchAfterBatchId(t,e){let n=e+1,s=this.br(n),i=s<0?0:s;return h.resolve(this.mutationQueue.length>i?this.mutationQueue[i]:null)}getHighestUnacknowledgedBatchId(){return h.resolve(this.mutationQueue.length===0?-1:this.yr-1)}getAllMutationBatches(t){return h.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){let n=new P(e,0),s=new P(e,Number.POSITIVE_INFINITY),i=[];return this.wr.forEachInRange([n,s],o=>{let a=this.Sr(o.pr);i.push(a)}),h.resolve(i)}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new O(A);return e.forEach(s=>{let i=new P(s,0),o=new P(s,Number.POSITIVE_INFINITY);this.wr.forEachInRange([i,o],a=>{n=n.add(a.pr)})}),h.resolve(this.Dr(n))}getAllMutationBatchesAffectingQuery(t,e){let n=e.path,s=n.length+1,i=n;E.isDocumentKey(i)||(i=i.child(""));let o=new P(new E(i),0),a=new O(A);return this.wr.forEachWhile(c=>{let u=c.key.path;return!!n.isPrefixOf(u)&&(u.length===s&&(a=a.add(c.pr)),!0)},o),h.resolve(this.Dr(a))}Dr(t){let e=[];return t.forEach(n=>{let s=this.Sr(n);s!==null&&e.push(s)}),e}removeMutationBatch(t,e){C(this.Cr(e.batchId,"removed")===0),this.mutationQueue.shift();let n=this.wr;return h.forEach(e.mutations,s=>{let i=new P(s.key,e.batchId);return n=n.delete(i),this.referenceDelegate.markPotentiallyOrphaned(t,s.key)}).next(()=>{this.wr=n})}Mn(t){}containsKey(t,e){let n=new P(e,0),s=this.wr.firstAfterOrEqual(n);return h.resolve(e.isEqual(s&&s.key))}performConsistencyCheck(t){return this.mutationQueue.length,h.resolve()}Cr(t,e){return this.br(t)}br(t){return this.mutationQueue.length===0?0:t-this.mutationQueue[0].batchId}Sr(t){let e=this.br(t);return e<0||e>=this.mutationQueue.length?null:this.mutationQueue[e]}};var On=class{constructor(t){this.vr=t,this.docs=function(){return new q(E.comparator)}(),this.size=0}setIndexManager(t){this.indexManager=t}addEntry(t,e){let n=e.key,s=this.docs.get(n),i=s?s.size:0,o=this.vr(e);return this.docs=this.docs.insert(n,{document:e.mutableCopy(),size:o}),this.size+=o-i,this.indexManager.addToCollectionParentIndex(t,n.path.popLast())}removeEntry(t){let e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){let n=this.docs.get(e);return h.resolve(n?n.document.mutableCopy():Rt.newInvalidDocument(e))}getEntries(t,e){let n=pe();return e.forEach(s=>{let i=this.docs.get(s);n=n.insert(s,i?i.document.mutableCopy():Rt.newInvalidDocument(s))}),h.resolve(n)}getDocumentsMatchingQuery(t,e,n,s){let i=pe(),o=e.path,a=new E(o.child("")),c=this.docs.getIteratorFrom(a);for(;c.hasNext();){let{key:u,value:{document:l}}=c.getNext();if(!o.isPrefixOf(u.path))break;u.path.length>o.length+1||li(ui(l),n)<=0||(s.has(l.key)||_r(e,l))&&(i=i.insert(l.key,l.mutableCopy()))}return h.resolve(i)}getAllFromCollectionGroup(t,e,n,s){w()}Fr(t,e){return h.forEach(this.docs,n=>e(n))}newChangeBuffer(t){return new qn(this)}getSize(t){return h.resolve(this.size)}},qn=class extends Cn{constructor(t){super(),this.ar=t}applyChanges(t){let e=[];return this.changes.forEach((n,s)=>{s.isValidDocument()?e.push(this.ar.addEntry(t,s)):this.ar.removeEntry(n)}),h.waitFor(e)}getFromCache(t,e){return this.ar.getEntry(t,e)}getAllFromCache(t,e){return this.ar.getEntries(t,e)}};var Bn=class{constructor(t){this.persistence=t,this.Mr=new et(e=>gr(e),pr),this.lastRemoteSnapshotVersion=S.min(),this.highestTargetId=0,this.Or=0,this.Nr=new te,this.targetCount=0,this.Br=Zt.Nn()}forEachTarget(t,e){return this.Mr.forEach((n,s)=>e(s)),h.resolve()}getLastRemoteSnapshotVersion(t){return h.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return h.resolve(this.Or)}allocateTargetId(t){return this.highestTargetId=this.Br.next(),h.resolve(this.highestTargetId)}setTargetsMetadata(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.Or&&(this.Or=e),h.resolve()}qn(t){this.Mr.set(t.target,t);let e=t.targetId;e>this.highestTargetId&&(this.Br=new Zt(e),this.highestTargetId=e),t.sequenceNumber>this.Or&&(this.Or=t.sequenceNumber)}addTargetData(t,e){return this.qn(e),this.targetCount+=1,h.resolve()}updateTargetData(t,e){return this.qn(e),h.resolve()}removeTargetData(t,e){return this.Mr.delete(e.target),this.Nr.Vr(e.targetId),this.targetCount-=1,h.resolve()}removeTargets(t,e,n){let s=0,i=[];return this.Mr.forEach((o,a)=>{a.sequenceNumber<=e&&n.get(a.targetId)===null&&(this.Mr.delete(o),i.push(this.removeMatchingKeysForTargetId(t,a.targetId)),s++)}),h.waitFor(i).next(()=>s)}getTargetCount(t){return h.resolve(this.targetCount)}getTargetData(t,e){let n=this.Mr.get(e)||null;return h.resolve(n)}addMatchingKeys(t,e,n){return this.Nr.dr(e,n),h.resolve()}removeMatchingKeys(t,e,n){this.Nr.Rr(e,n);let s=this.persistence.referenceDelegate,i=[];return s&&e.forEach(o=>{i.push(s.markPotentiallyOrphaned(t,o))}),h.waitFor(i)}removeMatchingKeysForTargetId(t,e){return this.Nr.Vr(e),h.resolve()}getMatchingKeysForTargetId(t,e){let n=this.Nr.gr(e);return h.resolve(n)}containsKey(t,e){return h.resolve(this.Nr.containsKey(e))}};var Un=class{constructor(t,e){this.Lr={},this.overlays={},this.kr=new di(0),this.qr=!1,this.qr=!0,this.referenceDelegate=t(this),this.Qr=new Bn(this),this.indexManager=new Dn,this.remoteDocumentCache=function(s){return new On(s)}(n=>this.referenceDelegate.Kr(n)),this.serializer=new Vn(e),this.$r=new Fn(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.qr=!1,Promise.resolve()}get started(){return this.qr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(t){return this.indexManager}getDocumentOverlayCache(t){let e=this.overlays[t.toKey()];return e||(e=new Mn,this.overlays[t.toKey()]=e),e}getMutationQueue(t,e){let n=this.Lr[t.toKey()];return n||(n=new Ln(e,this.referenceDelegate),this.Lr[t.toKey()]=n),n}getTargetCache(){return this.Qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.$r}runTransaction(t,e,n){m("MemoryPersistence","Starting transaction:",t);let s=new Gn(this.kr.next());return this.referenceDelegate.Ur(),n(s).next(i=>this.referenceDelegate.Wr(s).next(()=>i)).toPromise().then(i=>(s.raiseOnCommittedEvent(),i))}Gr(t,e){return h.or(Object.values(this.Lr).map(n=>()=>n.containsKey(t,e)))}},Gn=class extends en{constructor(t){super(),this.currentSequenceNumber=t}},zn=class r{constructor(t){this.persistence=t,this.zr=new te,this.jr=null}static Hr(t){return new r(t)}get Jr(){if(this.jr)return this.jr;throw w()}addReference(t,e,n){return this.zr.addReference(n,e),this.Jr.delete(n.toString()),h.resolve()}removeReference(t,e,n){return this.zr.removeReference(n,e),this.Jr.add(n.toString()),h.resolve()}markPotentiallyOrphaned(t,e){return this.Jr.add(e.toString()),h.resolve()}removeTarget(t,e){this.zr.Vr(e.targetId).forEach(s=>this.Jr.add(s.toString()));let n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(t,e.targetId).next(s=>{s.forEach(i=>this.Jr.add(i.toString()))}).next(()=>n.removeTargetData(t,e))}Ur(){this.jr=new Set}Wr(t){let e=this.persistence.getRemoteDocumentCache().newChangeBuffer();return h.forEach(this.Jr,n=>{let s=E.fromPath(n);return this.Yr(t,s).next(i=>{i||e.removeEntry(s,S.min())})}).next(()=>(this.jr=null,e.apply(t)))}updateLimboDocument(t,e){return this.Yr(t,e).next(n=>{n?this.Jr.delete(e.toString()):this.Jr.add(e.toString())})}Kr(t){return 0}Yr(t,e){return h.or([()=>h.resolve(this.zr.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.Gr(t,e)])}};var Kn=class r{constructor(t,e,n,s){this.targetId=t,this.fromCache=e,this.qi=n,this.Qi=s}static Ki(t,e){let n=M(),s=M();for(let i of e.docChanges)switch(i.type){case 0:n=n.add(i.doc.key);break;case 1:s=s.add(i.doc.key)}return new r(t,e.fromCache,n,s)}};var Qn=class{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(t){this._documentReadCount+=t}};var $n=class{constructor(){this.$i=!1,this.Ui=!1,this.Wi=100,this.Gi=function(){return Br()?8:he.v(Ut())>0?6:4}()}initialize(t,e){this.zi=t,this.indexManager=e,this.$i=!0}getDocumentsMatchingQuery(t,e,n,s){let i={result:null};return this.ji(t,e).next(o=>{i.result=o}).next(()=>{if(!i.result)return this.Hi(t,e,s,n).next(o=>{i.result=o})}).next(()=>{if(i.result)return;let o=new Qn;return this.Ji(t,e,o).next(a=>{if(i.result=a,this.Ui)return this.Yi(t,e,o,a.size)})}).next(()=>i.result)}Yi(t,e,n,s){return n.documentReadCount<this.Wi?(Kt()<=W.DEBUG&&m("QueryEngine","SDK will not create cache indexes for query:",Qt(e),"since it only creates cache indexes for collection contains","more than or equal to",this.Wi,"documents"),h.resolve()):(Kt()<=W.DEBUG&&m("QueryEngine","Query:",Qt(e),"scans",n.documentReadCount,"local documents and returns",s,"documents as results."),n.documentReadCount>this.Gi*s?(Kt()<=W.DEBUG&&m("QueryEngine","The SDK decides to create cache indexes for query:",Qt(e),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(t,ut(e))):h.resolve())}ji(t,e){if(fs(e))return h.resolve(null);let n=ut(e);return this.indexManager.getIndexType(t,n).next(s=>s===0?null:(e.limit!==null&&s===1&&(e=In(e,null,"F"),n=ut(e)),this.indexManager.getDocumentsMatchingTarget(t,n).next(i=>{let o=M(...i);return this.zi.getDocuments(t,o).next(a=>this.indexManager.getMinOffset(t,n).next(c=>{let u=this.Zi(e,a);return this.Xi(e,u,o,c.readTime)?this.ji(t,In(e,null,"F")):this.es(t,u,e,c)}))})))}Hi(t,e,n,s){return fs(e)||s.isEqual(S.min())?h.resolve(null):this.zi.getDocuments(t,n).next(i=>{let o=this.Zi(e,i);return this.Xi(e,o,n,s)?h.resolve(null):(Kt()<=W.DEBUG&&m("QueryEngine","Re-using previous result from %s to execute query: %s",s.toString(),Qt(e)),this.es(t,o,e,ci(s,-1)).next(a=>a))})}Zi(t,e){let n=new O(vi(t));return e.forEach((s,i)=>{_r(t,i)&&(n=n.add(i))}),n}Xi(t,e,n,s){if(t.limit===null)return!1;if(n.size!==e.size)return!0;let i=t.limitType==="F"?e.last():e.first();return!!i&&(i.hasPendingWrites||i.version.compareTo(s)>0)}Ji(t,e,n){return Kt()<=W.DEBUG&&m("QueryEngine","Using full collection scan to execute query:",Qt(e)),this.zi.getDocumentsMatchingQuery(t,e,dt.min(),n)}es(t,e,n,s){return this.zi.getDocumentsMatchingQuery(t,n,s).next(i=>(e.forEach(o=>{i=i.insert(o.key,o)}),i))}};var jn=class{constructor(t,e,n,s){this.persistence=t,this.ts=e,this.serializer=s,this.ns=new q(A),this.rs=new et(i=>gr(i),pr),this.ss=new Map,this.os=t.getRemoteDocumentCache(),this.Qr=t.getTargetCache(),this.$r=t.getBundleCache(),this._s(n)}_s(t){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(t),this.indexManager=this.persistence.getIndexManager(t),this.mutationQueue=this.persistence.getMutationQueue(t,this.indexManager),this.localDocuments=new kn(this.os,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.os.setIndexManager(this.indexManager),this.ts.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",e=>t.collect(e,this.ns))}};function Xi(r,t,e,n){return new jn(r,t,e,n)}function Ks(r,t){return p(this,null,function*(){let e=v(r);return yield e.persistence.runTransaction("Handle user change","readonly",n=>{let s;return e.mutationQueue.getAllMutationBatches(n).next(i=>(s=i,e._s(t),e.mutationQueue.getAllMutationBatches(n))).next(i=>{let o=[],a=[],c=M();for(let u of s){o.push(u.batchId);for(let l of u.mutations)c=c.add(l.key)}for(let u of i){a.push(u.batchId);for(let l of u.mutations)c=c.add(l.key)}return e.localDocuments.getDocuments(n,c).next(u=>({us:u,removedBatchIds:o,addedBatchIds:a}))})})})}function Zi(r,t){let e=v(r);return e.persistence.runTransaction("Acknowledge batch","readwrite-primary",n=>{let s=t.batch.keys(),i=e.os.newChangeBuffer({trackRemovals:!0});return function(a,c,u,l){let d=u.batch,g=d.keys(),_=h.resolve();return g.forEach(b=>{_=_.next(()=>l.getEntry(c,b)).next(V=>{let T=u.docVersions.get(b);C(T!==null),V.version.compareTo(T)<0&&(d.applyToRemoteDocument(V,u),V.isValidDocument()&&(V.setReadTime(u.commitVersion),l.addEntry(V)))})}),_.next(()=>a.mutationQueue.removeMutationBatch(c,d))}(e,n,t,i).next(()=>i.apply(n)).next(()=>e.mutationQueue.performConsistencyCheck(n)).next(()=>e.documentOverlayCache.removeOverlaysForBatchId(n,s,t.batch.batchId)).next(()=>e.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(n,function(a){let c=M();for(let u=0;u<a.mutationResults.length;++u)a.mutationResults[u].transformResults.length>0&&(c=c.add(a.batch.mutations[u].key));return c}(t))).next(()=>e.localDocuments.getDocuments(n,s))})}function to(r){let t=v(r);return t.persistence.runTransaction("Get last remote snapshot version","readonly",e=>t.Qr.getLastRemoteSnapshotVersion(e))}function eo(r,t){let e=v(r);return e.persistence.runTransaction("Get next mutation batch","readonly",n=>(t===void 0&&(t=-1),e.mutationQueue.getNextMutationBatchAfterBatchId(n,t)))}var ye=class{constructor(){this.activeTargetIds=Vi()}As(t){this.activeTargetIds=this.activeTargetIds.add(t)}Rs(t){this.activeTargetIds=this.activeTargetIds.delete(t)}ds(){let t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}};var Wn=class{constructor(){this.no=new ye,this.ro={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,n){}addLocalQueryTarget(t){return this.no.As(t),this.ro[t]||"not-current"}updateQueryState(t,e,n){this.ro[t]=e}removeLocalQueryTarget(t){this.no.Rs(t)}isLocalQueryTarget(t){return this.no.activeTargetIds.has(t)}clearQueryState(t){delete this.ro[t]}getAllActiveQueryTargets(){return this.no.activeTargetIds}isActiveQueryTarget(t){return this.no.activeTargetIds.has(t)}start(){return this.no=new ye,Promise.resolve()}handleUserChange(t,e,n){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(t){}};var Hn=class{io(t){}shutdown(){}};var we=class{constructor(){this.so=()=>this.oo(),this._o=()=>this.ao(),this.uo=[],this.co()}io(t){this.uo.push(t)}shutdown(){window.removeEventListener("online",this.so),window.removeEventListener("offline",this._o)}co(){window.addEventListener("online",this.so),window.addEventListener("offline",this._o)}oo(){m("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(let t of this.uo)t(0)}ao(){m("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(let t of this.uo)t(1)}static D(){return typeof window<"u"&&window.addEventListener!==void 0&&window.removeEventListener!==void 0}};var ae=null;function Ge(){return ae===null?ae=function(){return 268435456+Math.round(2147483648*Math.random())}():ae++,"0x"+ae.toString(16)}var no={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};var Yn=class{constructor(t){this.lo=t.lo,this.ho=t.ho}Po(t){this.Io=t}To(t){this.Eo=t}onMessage(t){this.Ao=t}close(){this.ho()}send(t){this.lo(t)}Ro(){this.Io()}Vo(t){this.Eo(t)}mo(t){this.Ao(t)}};var N="WebChannelConnection",Jn=class extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;let n=e.ssl?"https":"http",s=encodeURIComponent(this.databaseId.projectId),i=encodeURIComponent(this.databaseId.database);this.fo=n+"://"+e.host,this.po=`projects/${s}/databases/${i}`,this.yo=this.databaseId.database==="(default)"?`project_id=${s}`:`project_id=${s}&database_id=${i}`}get wo(){return!1}So(e,n,s,i,o){let a=Ge(),c=this.bo(e,n.toUriEncodedString());m("RestConnection",`Sending RPC '${e}' ${a}:`,c,s);let u={"google-cloud-resource-prefix":this.po,"x-goog-request-params":this.yo};return this.Do(u,i,o),this.Co(e,c,u,s).then(l=>(m("RestConnection",`Received RPC '${e}' ${a}: `,l),l),l=>{throw Qe("RestConnection",`RPC '${e}' ${a} failed with error: `,l,"url: ",c,"request:",s),l})}vo(e,n,s,i,o,a){return this.So(e,n,s,i,o)}Do(e,n,s){e["X-Goog-Api-Client"]=function(){return"gl-js/ fire/"+Ft}(),e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),n&&n.headers.forEach((i,o)=>e[o]=i),s&&s.headers.forEach((i,o)=>e[o]=i)}bo(e,n){let s=no[e];return`${this.fo}/v1/${n}:${s}`}terminate(){}}{constructor(t){super(t),this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams,this.longPollingOptions=t.longPollingOptions}Co(t,e,n,s){let i=Ge();return new Promise((o,a)=>{let c=new Yr;c.setWithCredentials(!0),c.listenOnce(Wr.COMPLETE,()=>{try{switch(c.getLastErrorCode()){case re.NO_ERROR:let l=c.getResponseJson();m(N,`XHR for RPC '${t}' ${i} received:`,JSON.stringify(l)),o(l);break;case re.TIMEOUT:m(N,`RPC '${t}' ${i} timed out`),a(new y(f.DEADLINE_EXCEEDED,"Request time out"));break;case re.HTTP_ERROR:let d=c.getStatus();if(m(N,`RPC '${t}' ${i} failed with status:`,d,"response text:",c.getResponseText()),d>0){let g=c.getResponseJson();Array.isArray(g)&&(g=g[0]);let _=g?.error;if(_&&_.status&&_.message){let b=function(T){let L=T.toLowerCase().replace(/_/g,"-");return Object.values(f).indexOf(L)>=0?L:f.UNKNOWN}(_.status);a(new y(b,_.message))}else a(new y(f.UNKNOWN,"Server responded with status "+c.getStatus()))}else a(new y(f.UNAVAILABLE,"Connection failed."));break;default:w()}}finally{m(N,`RPC '${t}' ${i} completed.`)}});let u=JSON.stringify(s);m(N,`RPC '${t}' ${i} sending request:`,s),c.send(e,"POST",u,n,15)})}Fo(t,e,n){let s=Ge(),i=[this.fo,"/","google.firestore.v1.Firestore","/",t,"/channel"],o=$r(),a=jr(),c={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},u=this.longPollingOptions.timeoutSeconds;u!==void 0&&(c.longPollingTimeout=Math.round(1e3*u)),this.useFetchStreams&&(c.useFetchStreams=!0),this.Do(c.initMessageHeaders,e,n),c.encodeInitMessageHeaders=!0;let l=i.join("");m(N,`Creating RPC '${t}' stream ${s}: ${l}`,c);let d=o.createWebChannel(l,c),g=!1,_=!1,b=new Yn({lo:T=>{_?m(N,`Not sending because RPC '${t}' stream ${s} is closed:`,T):(g||(m(N,`Opening RPC '${t}' stream ${s} transport.`),d.open(),g=!0),m(N,`RPC '${t}' stream ${s} sending:`,T),d.send(T))},ho:()=>d.close()}),V=(T,L,B)=>{T.listen(L,Y=>{try{B(Y)}catch(st){setTimeout(()=>{throw st},0)}})};return V(d,Gt.EventType.OPEN,()=>{_||m(N,`RPC '${t}' stream ${s} transport opened.`)}),V(d,Gt.EventType.CLOSE,()=>{_||(_=!0,m(N,`RPC '${t}' stream ${s} transport closed`),b.Vo())}),V(d,Gt.EventType.ERROR,T=>{_||(_=!0,Qe(N,`RPC '${t}' stream ${s} transport errored:`,T),b.Vo(new y(f.UNAVAILABLE,"The operation could not be completed")))}),V(d,Gt.EventType.MESSAGE,T=>{var L;if(!_){let B=T.data[0];C(!!B);let Y=B,st=Y.error||((L=Y[0])===null||L===void 0?void 0:L.error);if(st){m(N,`RPC '${t}' stream ${s} received error:`,st);let yr=st.status,Ve=function(ni){let Ir=R[ni];if(Ir!==void 0)return Oi(Ir)}(yr),wr=st.message;Ve===void 0&&(Ve=f.INTERNAL,wr="Unknown error status: "+yr+" with message "+st.message),_=!0,b.Vo(new y(Ve,wr)),d.close()}else m(N,`RPC '${t}' stream ${s} received:`,B),b.mo(B)}}),V(a,Hr.STAT_EVENT,T=>{T.stat===Me.PROXY?m(N,`RPC '${t}' stream ${s} detected buffering proxy`):T.stat===Me.NOPROXY&&m(N,`RPC '${t}' stream ${s} detected no buffering proxy`)}),setTimeout(()=>{b.Ro()},0),b}};function ze(){return typeof document<"u"?document:null}function Qs(r){return new Sn(r,!0)}var Ie=class{constructor(t,e,n=1e3,s=1.5,i=6e4){this.oi=t,this.timerId=e,this.Mo=n,this.xo=s,this.Oo=i,this.No=0,this.Bo=null,this.Lo=Date.now(),this.reset()}reset(){this.No=0}ko(){this.No=this.Oo}qo(t){this.cancel();let e=Math.floor(this.No+this.Qo()),n=Math.max(0,Date.now()-this.Lo),s=Math.max(0,e-n);s>0&&m("ExponentialBackoff",`Backing off for ${s} ms (base delay: ${this.No} ms, delay with jitter: ${e} ms, last attempt: ${n} ms ago)`),this.Bo=this.oi.enqueueAfterDelay(this.timerId,s,()=>(this.Lo=Date.now(),t())),this.No*=this.xo,this.No<this.Mo&&(this.No=this.Mo),this.No>this.Oo&&(this.No=this.Oo)}Ko(){this.Bo!==null&&(this.Bo.skipDelay(),this.Bo=null)}cancel(){this.Bo!==null&&(this.Bo.cancel(),this.Bo=null)}Qo(){return(Math.random()-.5)*this.No}};var Xn=class{constructor(t,e,n,s,i,o,a,c){this.oi=t,this.$o=n,this.Uo=s,this.connection=i,this.authCredentialsProvider=o,this.appCheckCredentialsProvider=a,this.listener=c,this.state=0,this.Wo=0,this.Go=null,this.zo=null,this.stream=null,this.jo=new Ie(t,e)}Ho(){return this.state===1||this.state===5||this.Jo()}Jo(){return this.state===2||this.state===3}start(){this.state!==4?this.auth():this.Yo()}stop(){return p(this,null,function*(){this.Ho()&&(yield this.close(0))})}Zo(){this.state=0,this.jo.reset()}Xo(){this.Jo()&&this.Go===null&&(this.Go=this.oi.enqueueAfterDelay(this.$o,6e4,()=>this.e_()))}t_(t){this.n_(),this.stream.send(t)}e_(){return p(this,null,function*(){if(this.Jo())return this.close(0)})}n_(){this.Go&&(this.Go.cancel(),this.Go=null)}r_(){this.zo&&(this.zo.cancel(),this.zo=null)}close(t,e){return p(this,null,function*(){this.n_(),this.r_(),this.jo.cancel(),this.Wo++,t!==4?this.jo.reset():e&&e.code===f.RESOURCE_EXHAUSTED?(Z(e.toString()),Z("Using maximum backoff delay to prevent overloading the backend."),this.jo.ko()):e&&e.code===f.UNAUTHENTICATED&&this.state!==3&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),this.stream!==null&&(this.i_(),this.stream.close(),this.stream=null),this.state=t,yield this.listener.To(e)})}i_(){}auth(){this.state=1;let t=this.s_(this.Wo),e=this.Wo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([n,s])=>{this.Wo===e&&this.o_(n,s)},n=>{t(()=>{let s=new y(f.UNKNOWN,"Fetching auth token failed: "+n.message);return this.__(s)})})}o_(t,e){let n=this.s_(this.Wo);this.stream=this.a_(t,e),this.stream.Po(()=>{n(()=>(this.state=2,this.zo=this.oi.enqueueAfterDelay(this.Uo,1e4,()=>(this.Jo()&&(this.state=3),Promise.resolve())),this.listener.Po()))}),this.stream.To(s=>{n(()=>this.__(s))}),this.stream.onMessage(s=>{n(()=>this.onMessage(s))})}Yo(){this.state=5,this.jo.qo(()=>p(this,null,function*(){this.state=0,this.start()}))}__(t){return m("PersistentStream",`close with error: ${t}`),this.stream=null,this.close(4,t)}s_(t){return e=>{this.oi.enqueueAndForget(()=>this.Wo===t?e():(m("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}};var Zn=class extends Xn{constructor(t,e,n,s,i,o){super(t,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",e,n,s,o),this.serializer=i,this.h_=!1}get P_(){return this.h_}start(){this.h_=!1,this.lastStreamToken=void 0,super.start()}i_(){this.h_&&this.I_([])}a_(t,e){return this.connection.Fo("Write",t,e)}onMessage(t){if(C(!!t.streamToken),this.lastStreamToken=t.streamToken,this.h_){this.jo.reset();let e=ji(t.writeResults,t.commitTime),n=It(t.commitTime);return this.listener.T_(n,e)}return C(!t.writeResults||t.writeResults.length===0),this.h_=!0,this.listener.E_()}d_(){let t={};t.database=Ki(this.serializer),this.t_(t)}I_(t){let e={streamToken:this.lastStreamToken,writes:t.map(n=>$i(this.serializer,n))};this.t_(e)}};var tr=class extends class{}{constructor(t,e,n,s){super(),this.authCredentials=t,this.appCheckCredentials=e,this.connection=n,this.serializer=s,this.A_=!1}R_(){if(this.A_)throw new y(f.FAILED_PRECONDITION,"The client has already been terminated.")}So(t,e,n,s){return this.R_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([i,o])=>this.connection.So(t,Rn(e,n),s,i,o)).catch(i=>{throw i.name==="FirebaseError"?(i.code===f.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),i):new y(f.UNKNOWN,i.toString())})}vo(t,e,n,s,i){return this.R_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([o,a])=>this.connection.vo(t,Rn(e,n),s,o,a,i)).catch(o=>{throw o.name==="FirebaseError"?(o.code===f.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),o):new y(f.UNKNOWN,o.toString())})}terminate(){this.A_=!0,this.connection.terminate()}};var er=class{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.m_=0,this.f_=null,this.g_=!0}p_(){this.m_===0&&(this.y_("Unknown"),this.f_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.f_=null,this.w_("Backend didn't respond within 10 seconds."),this.y_("Offline"),Promise.resolve())))}S_(t){this.state==="Online"?this.y_("Unknown"):(this.m_++,this.m_>=1&&(this.b_(),this.w_(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.y_("Offline")))}set(t){this.b_(),this.m_=0,t==="Online"&&(this.g_=!1),this.y_(t)}y_(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}w_(t){let e=`Could not reach Cloud Firestore backend. ${t}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.g_?(Z(e),this.g_=!1):m("OnlineStateTracker",e)}b_(){this.f_!==null&&(this.f_.cancel(),this.f_=null)}};var nr=class{constructor(t,e,n,s,i){this.localStore=t,this.datastore=e,this.asyncQueue=n,this.remoteSyncer={},this.D_=[],this.C_=new Map,this.v_=new Set,this.F_=[],this.M_=i,this.M_.io(o=>{n.enqueueAndForget(()=>p(this,null,function*(){ne(this)&&(m("RemoteStore","Restarting streams for network reachability change."),yield function(c){return p(this,null,function*(){let u=v(c);u.v_.add(4),yield ee(u),u.x_.set("Unknown"),u.v_.delete(4),yield Se(u)})}(this))}))}),this.x_=new er(n,s)}};function Se(r){return p(this,null,function*(){if(ne(r))for(let t of r.F_)yield t(!0)})}function ee(r){return p(this,null,function*(){for(let t of r.F_)yield t(!1)})}function ne(r){return v(r).v_.size===0}function $s(r,t,e){return p(this,null,function*(){if(!Ae(t))throw t;r.v_.add(1),yield ee(r),r.x_.set("Offline"),e||(e=()=>to(r.localStore)),r.asyncQueue.enqueueRetryable(()=>p(this,null,function*(){m("RemoteStore","Retrying IndexedDB access"),yield e(),r.v_.delete(1),yield Se(r)}))})}function js(r,t){return t().catch(e=>$s(r,e,t))}function Re(r){return p(this,null,function*(){let t=v(r),e=rt(t),n=t.D_.length>0?t.D_[t.D_.length-1].batchId:-1;for(;ro(t);)try{let s=yield eo(t.localStore,n);if(s===null){t.D_.length===0&&e.Xo();break}n=s.batchId,so(t,s)}catch(s){yield $s(t,s)}Ws(t)&&Hs(t)})}function ro(r){return ne(r)&&r.D_.length<10}function so(r,t){r.D_.push(t);let e=rt(r);e.Jo()&&e.P_&&e.I_(t.mutations)}function Ws(r){return ne(r)&&!rt(r).Ho()&&r.D_.length>0}function Hs(r){rt(r).start()}function io(r){return p(this,null,function*(){rt(r).d_()})}function oo(r){return p(this,null,function*(){let t=rt(r);for(let e of r.D_)t.I_(e.mutations)})}function ao(r,t,e){return p(this,null,function*(){let n=r.D_.shift(),s=An.from(n,t,e);yield js(r,()=>r.remoteSyncer.applySuccessfulWrite(s)),yield Re(r)})}function co(r,t){return p(this,null,function*(){t&&rt(r).P_&&(yield function(n,s){return p(this,null,function*(){if(function(o){return Li(o)&&o!==f.ABORTED}(s.code)){let i=n.D_.shift();rt(n).Zo(),yield js(n,()=>n.remoteSyncer.rejectFailedWrite(i.batchId,s)),yield Re(n)}})}(r,t)),Ws(r)&&Hs(r)})}function ws(r,t){return p(this,null,function*(){let e=v(r);e.asyncQueue.verifyOperationInProgress(),m("RemoteStore","RemoteStore received new credentials");let n=ne(e);e.v_.add(3),yield ee(e),n&&e.x_.set("Unknown"),yield e.remoteSyncer.handleCredentialChange(t),e.v_.delete(3),yield Se(e)})}function uo(r,t){return p(this,null,function*(){let e=v(r);t?(e.v_.delete(2),yield Se(e)):t||(e.v_.add(2),yield ee(e),e.x_.set("Unknown"))})}function rt(r){return r.B_||(r.B_=function(e,n,s){let i=v(e);return i.R_(),new Zn(n,i.connection,i.authCredentials,i.appCheckCredentials,i.serializer,s)}(r.datastore,r.asyncQueue,{Po:io.bind(null,r),To:co.bind(null,r),E_:oo.bind(null,r),T_:ao.bind(null,r)}),r.F_.push(t=>p(this,null,function*(){t?(r.B_.Zo(),yield Re(r)):(yield r.B_.stop(),r.D_.length>0&&(m("RemoteStore",`Stopping write stream with ${r.D_.length} pending writes`),r.D_=[]))}))),r.B_}var rr=class r{constructor(t,e,n,s,i){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=s,this.removalCallback=i,this.deferred=new K,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(o=>{})}get promise(){return this.deferred.promise}static createAndSchedule(t,e,n,s,i){let o=Date.now()+n,a=new r(t,e,o,s,i);return a.start(n),a}start(t){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){this.timerHandle!==null&&(this.clearTimeout(),this.deferred.reject(new y(f.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>this.timerHandle!==null?(this.clearTimeout(),this.op().then(t=>this.deferred.resolve(t))):Promise.resolve())}clearTimeout(){this.timerHandle!==null&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}};function Ys(r,t){if(Z("AsyncQueue",`${t}: ${r}`),Ae(r))return new y(f.UNAVAILABLE,`${t}: ${r}`);throw r}var sr=class{constructor(){this.queries=new et(t=>Ns(t),Cs),this.onlineState="Unknown",this.K_=new Set}};function lo(r){r.K_.forEach(t=>{t.next()})}var ir=class{constructor(t,e,n,s,i,o){this.localStore=t,this.remoteStore=e,this.eventManager=n,this.sharedClientState=s,this.currentUser=i,this.maxConcurrentLimboResolutions=o,this.fa={},this.ga=new et(a=>Ns(a),Cs),this.pa=new Map,this.ya=new Set,this.wa=new q(E.comparator),this.Sa=new Map,this.ba=new te,this.Da={},this.Ca=new Map,this.va=Zt.Bn(),this.onlineState="Unknown",this.Fa=void 0}get isPrimaryClient(){return this.Fa===!0}};function ho(r,t,e){return p(this,null,function*(){let n=po(r);try{let s=yield function(o,a){let c=v(o),u=U.now(),l=a.reduce((_,b)=>_.add(b.key),M()),d,g;return c.persistence.runTransaction("Locally write mutations","readwrite",_=>{let b=pe(),V=M();return c.os.getEntries(_,l).next(T=>{b=T,b.forEach((L,B)=>{B.isValidDocument()||(V=V.add(L))})}).next(()=>c.localDocuments.getOverlayedDocuments(_,b)).next(T=>{d=T;let L=[];for(let B of a){let Y=Mi(B,d.get(B.key).overlayedDocument);Y!=null&&L.push(new nt(B.key,Y,Ss(Y.value.mapValue),lt.exists(!0)))}return c.mutationQueue.addMutationBatch(_,u,L,a)}).next(T=>{g=T;let L=T.applyToLocalDocumentSet(d,V);return c.documentOverlayCache.saveOverlays(_,T.batchId,L)})}).then(()=>({batchId:g.batchId,changes:Fs(d)}))}(n.localStore,t);n.sharedClientState.addPendingMutation(s.batchId),function(o,a,c){let u=o.Da[o.currentUser.toKey()];u||(u=new q(A)),u=u.insert(a,c),o.Da[o.currentUser.toKey()]=u}(n,s.batchId,e),yield Pe(n,s.changes),yield Re(n.remoteStore)}catch(s){let i=Ys(s,"Failed to persist write");e.reject(i)}})}function Is(r,t,e){let n=v(r);if(n.isPrimaryClient&&e===0||!n.isPrimaryClient&&e===1){let s=[];n.ga.forEach((i,o)=>{let a=o.view.U_(t);a.snapshot&&s.push(a.snapshot)}),function(o,a){let c=v(o);c.onlineState=a;let u=!1;c.queries.forEach((l,d)=>{for(let g of d.Q_)g.U_(a)&&(u=!0)}),u&&lo(c)}(n.eventManager,t),s.length&&n.fa.u_(s),n.onlineState=t,n.isPrimaryClient&&n.sharedClientState.setOnlineState(t)}}function fo(r,t){return p(this,null,function*(){let e=v(r),n=t.batch.batchId;try{let s=yield Zi(e.localStore,t);Xs(e,n,null),Js(e,n),e.sharedClientState.updateMutationState(n,"acknowledged"),yield Pe(e,s)}catch(s){yield vs(s)}})}function mo(r,t,e){return p(this,null,function*(){let n=v(r);try{let s=yield function(o,a){let c=v(o);return c.persistence.runTransaction("Reject batch","readwrite-primary",u=>{let l;return c.mutationQueue.lookupMutationBatch(u,a).next(d=>(C(d!==null),l=d.keys(),c.mutationQueue.removeMutationBatch(u,d))).next(()=>c.mutationQueue.performConsistencyCheck(u)).next(()=>c.documentOverlayCache.removeOverlaysForBatchId(u,l,a)).next(()=>c.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(u,l)).next(()=>c.localDocuments.getDocuments(u,l))})}(n.localStore,t);Xs(n,t,e),Js(n,t),n.sharedClientState.updateMutationState(t,"rejected",e),yield Pe(n,s)}catch(s){yield vs(s)}})}function Js(r,t){(r.Ca.get(t)||[]).forEach(e=>{e.resolve()}),r.Ca.delete(t)}function Xs(r,t,e){let n=v(r),s=n.Da[n.currentUser.toKey()];if(s){let i=s.get(t);i&&(e?i.reject(e):i.resolve(),s=s.remove(t)),n.Da[n.currentUser.toKey()]=s}}function Pe(r,t,e){return p(this,null,function*(){let n=v(r),s=[],i=[],o=[];n.ga.isEmpty()||(n.ga.forEach((a,c)=>{o.push(n.Ma(c,t,e).then(u=>{if((u||e)&&n.isPrimaryClient&&n.sharedClientState.updateQueryState(c.targetId,u?.fromCache?"not-current":"current"),u){s.push(u);let l=Kn.Ki(c.targetId,u);i.push(l)}}))}),yield Promise.all(o),n.fa.u_(s),yield function(c,u){return p(this,null,function*(){let l=v(c);try{yield l.persistence.runTransaction("notifyLocalViewChanges","readwrite",d=>h.forEach(u,g=>h.forEach(g.qi,_=>l.persistence.referenceDelegate.addReference(d,g.targetId,_)).next(()=>h.forEach(g.Qi,_=>l.persistence.referenceDelegate.removeReference(d,g.targetId,_)))))}catch(d){if(!Ae(d))throw d;m("LocalStore","Failed to update sequence numbers: "+d)}for(let d of u){let g=d.targetId;if(!d.fromCache){let _=l.ns.get(g),b=_.snapshotVersion,V=_.withLastLimboFreeSnapshotVersion(b);l.ns=l.ns.insert(g,V)}}})}(n.localStore,i))})}function go(r,t){return p(this,null,function*(){let e=v(r);if(!e.currentUser.isEqual(t)){m("SyncEngine","User change. New user:",t.toKey());let n=yield Ks(e.localStore,t);e.currentUser=t,function(i,o){i.Ca.forEach(a=>{a.forEach(c=>{c.reject(new y(f.CANCELLED,o))})}),i.Ca.clear()}(e,"'waitForPendingWrites' promise is rejected due to a user change."),e.sharedClientState.handleUserChange(t,n.removedBatchIds,n.addedBatchIds),yield Pe(e,n.us)}})}function po(r){let t=v(r);return t.remoteStore.remoteSyncer.applySuccessfulWrite=fo.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=mo.bind(null,t),t}var Ee=class{constructor(){this.synchronizeTabs=!1}initialize(t){return p(this,null,function*(){this.serializer=Qs(t.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(t),this.persistence=this.createPersistence(t),yield this.persistence.start(),this.localStore=this.createLocalStore(t),this.gcScheduler=this.createGarbageCollectionScheduler(t,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(t,this.localStore)})}createGarbageCollectionScheduler(t,e){return null}createIndexBackfillerScheduler(t,e){return null}createLocalStore(t){return Xi(this.persistence,new $n,t.initialUser,this.serializer)}createPersistence(t){return new Un(zn.Hr,this.serializer)}createSharedClientState(t){return new Wn}terminate(){return p(this,null,function*(){var t,e;(t=this.gcScheduler)===null||t===void 0||t.stop(),(e=this.indexBackfillerScheduler)===null||e===void 0||e.stop(),this.sharedClientState.shutdown(),yield this.persistence.shutdown()})}};var or=class{initialize(t,e){return p(this,null,function*(){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=n=>Is(this.syncEngine,n,1),this.remoteStore.remoteSyncer.handleCredentialChange=go.bind(null,this.syncEngine),yield uo(this.remoteStore,this.syncEngine.isPrimaryClient))})}createEventManager(t){return function(){return new sr}()}createDatastore(t){let e=Qs(t.databaseInfo.databaseId),n=function(i){return new Jn(i)}(t.databaseInfo);return function(i,o,a,c){return new tr(i,o,a,c)}(t.authCredentials,t.appCheckCredentials,n,e)}createRemoteStore(t){return function(n,s,i,o,a){return new nr(n,s,i,o,a)}(this.localStore,this.datastore,t.asyncQueue,e=>Is(this.syncEngine,e,0),function(){return we.D()?new we:new Hn}())}createSyncEngine(t,e){return function(s,i,o,a,c,u,l){let d=new ir(s,i,o,a,c,u);return l&&(d.Fa=!0),d}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)}terminate(){return p(this,null,function*(){var t;yield function(n){return p(this,null,function*(){let s=v(n);m("RemoteStore","RemoteStore shutting down."),s.v_.add(5),yield ee(s),s.M_.shutdown(),s.x_.set("Unknown")})}(this.remoteStore),(t=this.datastore)===null||t===void 0||t.terminate()})}};var ar=class{constructor(t,e,n,s){this.authCredentials=t,this.appCheckCredentials=e,this.asyncQueue=n,this.databaseInfo=s,this.user=k.UNAUTHENTICATED,this.clientId=Ze.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,i=>p(this,null,function*(){m("FirestoreClient","Received user=",i.uid),yield this.authCredentialListener(i),this.user=i})),this.appCheckCredentials.start(n,i=>(m("FirestoreClient","Received new app check token=",i),this.appCheckCredentialListener(i,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.authCredentialListener=t}setAppCheckTokenChangeListener(t){this.appCheckCredentialListener=t}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new y(f.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();let t=new K;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(()=>p(this,null,function*(){try{this._onlineComponents&&(yield this._onlineComponents.terminate()),this._offlineComponents&&(yield this._offlineComponents.terminate()),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),t.resolve()}catch(e){let n=Ys(e,"Failed to shutdown persistence");t.reject(n)}})),t.promise}};function Ke(r,t){return p(this,null,function*(){r.asyncQueue.verifyOperationInProgress(),m("FirestoreClient","Initializing OfflineComponentProvider");let e=r.configuration;yield t.initialize(e);let n=e.initialUser;r.setCredentialChangeListener(s=>p(this,null,function*(){n.isEqual(s)||(yield Ks(t.localStore,s),n=s)})),t.persistence.setDatabaseDeletedListener(()=>r.terminate()),r._offlineComponents=t})}function Es(r,t){return p(this,null,function*(){r.asyncQueue.verifyOperationInProgress();let e=yield yo(r);m("FirestoreClient","Initializing OnlineComponentProvider"),yield t.initialize(e,r.configuration),r.setCredentialChangeListener(n=>ws(t.remoteStore,n)),r.setAppCheckTokenChangeListener((n,s)=>ws(t.remoteStore,s)),r._onlineComponents=t})}function _o(r){return r.name==="FirebaseError"?r.code===f.FAILED_PRECONDITION||r.code===f.UNIMPLEMENTED:!(typeof DOMException<"u"&&r instanceof DOMException)||r.code===22||r.code===20||r.code===11}function yo(r){return p(this,null,function*(){if(!r._offlineComponents)if(r._uninitializedComponentsProvider){m("FirestoreClient","Using user provided OfflineComponentProvider");try{yield Ke(r,r._uninitializedComponentsProvider._offline)}catch(t){let e=t;if(!_o(e))throw e;Qe("Error using user provided cache. Falling back to memory cache: "+e),yield Ke(r,new Ee)}}else m("FirestoreClient","Using default OfflineComponentProvider"),yield Ke(r,new Ee);return r._offlineComponents})}function wo(r){return p(this,null,function*(){return r._onlineComponents||(r._uninitializedComponentsProvider?(m("FirestoreClient","Using user provided OnlineComponentProvider"),yield Es(r,r._uninitializedComponentsProvider._online)):(m("FirestoreClient","Using default OnlineComponentProvider"),yield Es(r,new or))),r._onlineComponents})}function Io(r){return wo(r).then(t=>t.syncEngine)}function Zs(r){let t={};return r.timeoutSeconds!==void 0&&(t.timeoutSeconds=r.timeoutSeconds),t}var Ts=new Map;function Eo(r,t,e,n){if(t===!0&&n===!0)throw new y(f.INVALID_ARGUMENT,`${r} and ${e} cannot be used together.`)}function To(r){if(r===void 0)return"undefined";if(r===null)return"null";if(typeof r=="string")return r.length>20&&(r=`${r.substring(0,20)}...`),JSON.stringify(r);if(typeof r=="number"||typeof r=="boolean")return""+r;if(typeof r=="object"){if(r instanceof Array)return"an array";{let t=function(n){return n.constructor?n.constructor.name:null}(r);return t?`a custom ${t} object`:"an object"}}return typeof r=="function"?"a function":w()}function vo(r,t){if("_delegate"in r&&(r=r._delegate),!(r instanceof t)){if(t.name===r.constructor.name)throw new y(f.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{let e=To(r);throw new y(f.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${e}`)}}return r}var Te=class{constructor(t){var e,n;if(t.host===void 0){if(t.ssl!==void 0)throw new y(f.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=t.host,this.ssl=(e=t.ssl)===null||e===void 0||e;if(this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,this.localCache=t.localCache,t.cacheSizeBytes===void 0)this.cacheSizeBytes=41943040;else{if(t.cacheSizeBytes!==-1&&t.cacheSizeBytes<1048576)throw new y(f.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}Eo("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:t.experimentalAutoDetectLongPolling===void 0?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=Zs((n=t.experimentalLongPollingOptions)!==null&&n!==void 0?n:{}),function(i){if(i.timeoutSeconds!==void 0){if(isNaN(i.timeoutSeconds))throw new y(f.INVALID_ARGUMENT,`invalid long polling timeout: ${i.timeoutSeconds} (must not be NaN)`);if(i.timeoutSeconds<5)throw new y(f.INVALID_ARGUMENT,`invalid long polling timeout: ${i.timeoutSeconds} (minimum allowed value is 5)`);if(i.timeoutSeconds>30)throw new y(f.INVALID_ARGUMENT,`invalid long polling timeout: ${i.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!t.useFetchStreams}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&function(n,s){return n.timeoutSeconds===s.timeoutSeconds}(this.experimentalLongPollingOptions,t.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}},cr=class{constructor(t,e,n,s){this._authCredentials=t,this._appCheckCredentials=e,this._databaseId=n,this._app=s,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Te({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new y(f.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return this._terminateTask!==void 0}_setSettings(t){if(this._settingsFrozen)throw new y(f.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Te(t),t.credentials!==void 0&&(this._authCredentials=function(n){if(!n)return new je;switch(n.type){case"firstParty":return new Ye(n.sessionIndex||"0",n.iamToken||null,n.authTokenFactory||null);case"provider":return n.client;default:throw new y(f.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){let n=Ts.get(e);n&&(m("ComponentProvider","Removing Datastore"),Ts.delete(e),n.terminate())}(this),Promise.resolve()}};var ur=class{constructor(){this.Xa=Promise.resolve(),this.eu=[],this.tu=!1,this.nu=[],this.ru=null,this.iu=!1,this.su=!1,this.ou=[],this.jo=new Ie(this,"async_queue_retry"),this._u=()=>{let e=ze();e&&m("AsyncQueue","Visibility state changed to "+e.visibilityState),this.jo.Ko()};let t=ze();t&&typeof t.addEventListener=="function"&&t.addEventListener("visibilitychange",this._u)}get isShuttingDown(){return this.tu}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.au(),this.uu(t)}enterRestrictedMode(t){if(!this.tu){this.tu=!0,this.su=t||!1;let e=ze();e&&typeof e.removeEventListener=="function"&&e.removeEventListener("visibilitychange",this._u)}}enqueue(t){if(this.au(),this.tu)return new Promise(()=>{});let e=new K;return this.uu(()=>this.tu&&this.su?Promise.resolve():(t().then(e.resolve,e.reject),e.promise)).then(()=>e.promise)}enqueueRetryable(t){this.enqueueAndForget(()=>(this.eu.push(t),this.cu()))}cu(){return p(this,null,function*(){if(this.eu.length!==0){try{yield this.eu[0](),this.eu.shift(),this.jo.reset()}catch(t){if(!Ae(t))throw t;m("AsyncQueue","Operation failed with retryable error: "+t)}this.eu.length>0&&this.jo.qo(()=>this.cu())}})}uu(t){let e=this.Xa.then(()=>(this.iu=!0,t().catch(n=>{this.ru=n,this.iu=!1;let s=function(o){let a=o.message||"";return o.stack&&(a=o.stack.includes(o.message)?o.stack:o.message+`
`+o.stack),a}(n);throw Z("INTERNAL UNHANDLED ERROR: ",s),n}).then(n=>(this.iu=!1,n))));return this.Xa=e,e}enqueueAfterDelay(t,e,n){this.au(),this.ou.indexOf(t)>-1&&(e=0);let s=rr.createAndSchedule(this,t,e,n,i=>this.lu(i));return this.nu.push(s),s}au(){this.ru&&w()}verifyOperationInProgress(){}hu(){return p(this,null,function*(){let t;do t=this.Xa,yield t;while(t!==this.Xa)})}Pu(t){for(let e of this.nu)if(e.timerId===t)return!0;return!1}Iu(t){return this.hu().then(()=>{this.nu.sort((e,n)=>e.targetTimeMs-n.targetTimeMs);for(let e of this.nu)if(e.skipDelay(),t!=="all"&&e.timerId===t)break;return this.hu()})}Tu(t){this.ou.push(t)}lu(t){let e=this.nu.indexOf(t);this.nu.splice(e,1)}};var ve=class extends cr{constructor(t,e,n,s){super(t,e,n,s),this.type="firestore",this._queue=function(){return new ur}(),this._persistenceKey=s?.name||"[DEFAULT]"}_terminate(){return this._firestoreClient||ti(this),this._firestoreClient.terminate()}};function Ao(r){return r._firestoreClient||ti(r),r._firestoreClient.verifyNotTerminated(),r._firestoreClient}function ti(r){var t,e,n;let s=r._freezeSettings(),i=function(a,c,u,l){return new an(a,c,u,l.host,l.ssl,l.experimentalForceLongPolling,l.experimentalAutoDetectLongPolling,Zs(l.experimentalLongPollingOptions),l.useFetchStreams)}(r._databaseId,((t=r._app)===null||t===void 0?void 0:t.options.appId)||"",r._persistenceKey,s);r._firestoreClient=new ar(r._authCredentials,r._appCheckCredentials,r._queue,i),!((e=s.localCache)===null||e===void 0)&&e._offlineComponentProvider&&(!((n=s.localCache)===null||n===void 0)&&n._onlineComponentProvider)&&(r._firestoreClient._uninitializedComponentsProvider={_offlineKind:s.localCache.kind,_offline:s.localCache._offlineComponentProvider,_online:s.localCache._onlineComponentProvider})}var ra=new RegExp("[~\\*/\\[\\]]");function ei(r){return bo(vo(r.firestore,ve),[new Xt(r._key,lt.none())])}function bo(r,t){return function(n,s){let i=new K;return n.asyncQueue.enqueueAndForget(()=>p(this,null,function*(){return ho(yield Io(n),s,i)})),i.promise}(Ao(r),t)}(function(t,e=!0){(function(s){Ft=s})(Qr),Kr(new zr("firestore",(n,{instanceIdentifier:s,options:i})=>{let o=n.getProvider("app").getImmediate(),a=new ve(new We(n.getProvider("auth-internal")),new Xe(n.getProvider("app-check-internal")),function(u,l){if(!Object.prototype.hasOwnProperty.apply(u.options,["projectId"]))throw new y(f.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new cn(u.options.projectId,l)}(o,s),o);return i=Object.assign({useFetchStreams:e},i),a._setSettings(i),a},"PUBLIC").setMultipleInstances(!0)),Fe(os,"4.4.3",t),Fe(os,"4.4.3","esm2017")})();var fa=(()=>{let t=class t{constructor(){this.firestore=Ar(Xr)}list(n){let s=Le(this.firestore,"posts"),i=[es(n.sort,n.order),ts(n.limit)];n.query&&i.push(Be(n.sort,">=",n.query.toLowerCase()),Be(n.sort,"<=",n.query.toLowerCase()+"\uF8FF"));let o=ns(s,...i),a=J(qe(s)).pipe(j(u=>u.size)),c=J(qe(o)).pipe(j(u=>{let l=[];return u.forEach(d=>{let g=d.data();l.push(pt({id:d.id},g))}),l}));return Er([a,c]).pipe(j(([u,l])=>({items:l,totalCount:u})))}create(n){return J(Zr(Le(this.firestore,"posts"),pt({},n))).pipe(De(s=>J(Oe(s))),j(s=>{let i=s.data();return pt({id:s.id},i)}))}detail(n){let s=se(this.firestore,"posts",n);return J(Oe(s)).pipe(j(i=>pt({id:n},i.data())))}delete(n){let s=se(this.firestore,"posts",n);return J(ei(s)).pipe(j(()=>{}))}patch(n,s){let i=se(this.firestore,"posts",n);return J(rs(i,pt({},s))).pipe(De(()=>this.detail(n)))}};t.\u0275fac=function(s){return new(s||t)},t.\u0275prov=_t({token:t,factory:t.\u0275fac,providedIn:"root"});let r=t;return r})();export{zt as a,ko as b,fa as c};
